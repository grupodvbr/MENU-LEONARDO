<script>
  // ====== CONFIG ======
  const WEBAPP = 'https://script.google.com/macros/s/AKfycbzVR_6hWjV3znWB41HQjhUhGjDT-nq9RmIJy89LXETGJ9tJmf9_cAv6msxa7MNCf4JpZw/exec';

  // ====== Helpers ======
  const qs = (id)=>document.getElementById(id);
  const setBusy = (b)=>{ qs('btn').disabled=b; qs('btn').textContent=b?'Verificando…':'Entrar'; }
  const showErr = (m)=>{ const el=qs('err'); el.textContent=m||''; el.style.display=m?'block':'none'; qs('ok').style.display='none'; }
  const showOk  = (m)=>{ const el=qs('ok');  el.innerHTML=m||''; el.style.display=m?'block':'none'; qs('err').style.display='none'; }

  // === Redirect robusto ===
  function getRedirectUrl(){
    const cur = new URL(location.href);
    const qnext = cur.searchParams.get('next');
    if (qnext) {                      // aceita relativo (ex: index.relatorios.html) ou absoluto
      try { return new URL(qnext, cur).href; } catch {}
    }
    const base = cur.href.slice(0, cur.href.lastIndexOf('/') + 1);
    return base + 'index.html';       // default: index.html na MESMA pasta do login
  }
  function redirectNow(){
    const dest = getRedirectUrl();
    window.location.replace(dest);    // não volta pro login no botão "voltar"
    setTimeout(()=>{                  // fallback caso algum navegador ignore o replace
      if (location.href.includes('login')) location.href = dest;
    }, 200);
  }

  // id único do dispositivo (persistido no browser)
  function getOrCreateDeviceId(){
    const k='dv_device_id';
    let v=localStorage.getItem(k);
    if(!v){ v=(crypto.randomUUID?.() || (Date.now().toString(36)+Math.random().toString(36).slice(2))); localStorage.setItem(k,v); }
    return v;
  }

  function saveSession(j){
    localStorage.setItem('auth_token', j.token);
    localStorage.setItem('auth_user', JSON.stringify({usuario:j.usuario, empresa:j.empresa, perfil:j.perfil}));
  }

  // ====== Verificar sessão (me) – sem Authorization p/ evitar preflight ======
  async function me(){
    const token = localStorage.getItem('auth_token');
    if(!token) return null;
    try{
      const r = await fetch(`${WEBAPP}?fn=me`, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
        body: JSON.stringify({ token, device_id:getOrCreateDeviceId() })
      });
      const raw = await r.text();
      const j = JSON.parse(raw);
      return j.ok ? j.user : null;
    }catch{ return null; }
  }

  // Auto-login se já houver token válido
  (async ()=>{ const u = await me(); if(u) redirectNow(); })();

  // UI
  qs('toggle').addEventListener('click', ()=>{
    const f=qs('senha'); const isPw=f.type==='password';
    f.type = isPw ? 'text' : 'password';
    qs('toggle').textContent = isPw ? 'ocultar' : 'mostrar';
    f.focus();
  });

  // ====== Login (com aprovação de aparelho) ======
  qs('form').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    showErr(''); showOk('');
    const usuario = qs('usuario').value.trim();
    const senha   = qs('senha').value;
    const remember= qs('remember').checked;
    if(!usuario || !senha){ showErr('Preencha usuário e senha.'); return; }

    setBusy(true);
    try{
      const r = await fetch(`${WEBAPP}?fn=login`, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=UTF-8' }, // evita CORS preflight
        body: JSON.stringify({
          usuario, senha, remember,
          device: { id:getOrCreateDeviceId(), ua:navigator.userAgent, w:innerWidth, h:innerHeight }
        })
      });
      const raw = await r.text();
      let j; try{ j=JSON.parse(raw); }catch{ showErr('Resposta inválida do servidor.'); setBusy(false); return; }

      if(j.status === 'pending'){
        showOk('✅ Dispositivo registrado. Aguarde o administrador liberar este aparelho e tente novamente.');
        setBusy(false);
        return;
      }

      if(!j.ok){
        if(j.error==='blocked') showErr(`Muitas tentativas. Tente novamente em ${j.minutes} min.`);
        else if(j.error==='invalid_credentials') showErr('Usuário ou senha inválidos.');
        else showErr('Não foi possível entrar agora.');
        setBusy(false);
        return;
      }

      saveSession(j);
      const destino = getRedirectUrl();
      showOk(`Acesso autorizado. Redirecionando… Se não for automático, <a href="${destino}">clique aqui</a>.`);
      setTimeout(redirectNow, 150);
    }catch(e){
      showErr('Falha de rede. Tente novamente.');
    }finally{
      setBusy(false);
    }
  });
</script>
