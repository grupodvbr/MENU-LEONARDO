<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel ABC de Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0d0f14; --panel:#121826; --card:#171c2b; --ink:#e9ecf1; --mut:#a9b2c7; --line:#243048;
      --brand:#7c5cff; --brand-2:#22d3ee; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1e293b; --shadow:0 10px 30px rgba(0,0,0,.20);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b0d12,#0d1220 40%, #0a1327);
      font-family: Inter, system-ui, Arial, sans-serif; color:var(--ink); font-size:14px;
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background:linear-gradient(90deg,#10182b,#0f1531);
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:14px 16px; display:flex; align-items:center; gap:14px;
    }
    header img{height:44px; filter:drop-shadow(0 6px 16px rgba(0,0,0,.35))}
    header h1{margin:0; font-size:1.15rem; font-weight:800; letter-spacing:.3px; flex:1; text-align:center}
    .container{padding:18px; max-width:1200px; margin:0 auto}

    /* Filtros */
    .filters{
      display:grid; gap:12px; grid-template-columns: repeat(12,1fr);
      background:linear-gradient(180deg,#151b2c,#121826);
      border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow: var(--shadow);
    }
    .filters .field{grid-column: span 12; display:flex; flex-direction:column; gap:6px}
    .filters .field.half{grid-column: span 6}
    .filters .field.third{grid-column: span 4}
    .filters label{font-weight:600; color:#c7d2fe; font-size:.85rem}
    .filters input, .filters select{
      background:#0d1322; border:1px solid #2a3652; color:var(--ink);
      padding:10px 12px; border-radius:10px; outline:none;
    }
    .filters input::placeholder{color:#7b88a6}
    .filters .actions{grid-column: span 12; display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; cursor:pointer;
      border:1px solid transparent; font-weight:700; letter-spacing:.2px; transition:.2s;
    }
    .btn-brand{ background:linear-gradient(90deg,var(--brand),#5aa8ff); color:#071022; }
    .btn-brand:hover{ filter:brightness(1.05) }
    .btn-ghost{ background:#0d1322; color:#dce3f7; border-color:#2a3652 }
    .btn-ghost:hover{ background:#121a2f }
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    /* Resumo */
    .resumo-geral{
      display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:16px 0 22px 0;
    }
    .kpi{
      background:linear-gradient(180deg,#151b2c,#121826);
      border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow);
      display:flex; align-items:center; gap:12px;
    }
    .kpi .dot{width:12px; height:12px; border-radius:50%}
    .kpi-title{color:#9fb0d9; font-weight:700; font-size:.9rem}
    .kpi-value{font-size:1.2rem; font-weight:900}

    /* Cards & canvas */
    canvas, .card-analise, #menuFiltroVenda, #listaVendas>div{
      background:linear-gradient(180deg,#151b2c,#121826);
      border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow);
    }
    canvas{margin-bottom:22px}
    .analise-flex{display:grid; grid-template-columns: repeat(3,1fr); gap:16px; margin-bottom:22px}
    .card-analise h3{margin:0 0 8px 0; color:#dbe3ff; font-size:1rem}
    .bloco-com-vendas{background:rgba(22,163,74,.10); border-left:6px solid var(--ok)}
    .bloco-sem-vendas{background:rgba(239,68,68,.08); border-left:6px solid var(--danger)}
    #semVendas div{cursor:pointer; color:#ffb4b4}

    /* Popup */
    #popupOverlay{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.65); z-index:30;
    }
    #popupContent{
      position:relative; background:linear-gradient(180deg,#161b2b,#121826);
      border:1px solid var(--line); border-radius:18px; padding:18px; width:min(920px,92vw); max-height:90vh; overflow:auto;
      box-shadow: var(--shadow);
    }
    #popupClose{position:absolute; right:14px; top:10px; font-size:22px; font-weight:800; cursor:pointer; color:#cfd8ff}
    #graficoVendas{display:none; max-width:900px; height:320px !important; margin: 0 auto 22px}

    /* Loader tela cheia */
    #loadingOverlay{
      position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1200px 600px at 50% -10%, rgba(124,92,255,.25), transparent 60%), #0a0f1b; z-index:50;
    }
    .spinner{
      width:64px; height:64px; border-radius:50%; border:5px solid #243048; border-top-color:var(--brand);
      animation:spin .9s linear infinite; margin:18px auto 8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-title{font-weight:900; letter-spacing:.3px}
    .loading-sub{color:#9fb0d9; font-size:.9rem}

    /* Mini loader para aplicar filtros */
    #miniLoading{display:none; gap:10px; align-items:center; color:#9fb0d9}
    #miniLoading .dot{width:10px; height:10px; border-radius:50%; background:var(--brand); animation:blink 1.2s infinite ease-in-out}
    #miniLoading .d2{animation-delay:.2s} .d3{animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2} 40%{opacity:1}}

    /* Responsivo */
    @media (max-width: 960px){
      .filters .field.half{grid-column: span 12}
      .filters .field.third{grid-column: span 12}
      .resumo-geral{grid-template-columns:1fr}
      .analise-flex{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Loader inicial -->
  <div id="loadingOverlay">
    <div style="text-align:center">
      <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo" style="height:72px; filter:drop-shadow(0 6px 18px rgba(0,0,0,.45))">
      <div class="spinner"></div>
      <div class="loading-title">Carregando dados do ABC de Vendas‚Ä¶</div>
      <div class="loading-sub">Conectando √† planilha e preparando an√°lises</div>
    </div>
  </div>

  <header>
    <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo CB Systems">
    <h1 id="tituloPainel">ABC DE VENDAS ‚Ä¢ GRUPO DV</h1>
  </header>

  <div class="container">
    <section class="filters" id="filtrosForm">
      <div class="field third">
        <label>üìÖ Data In√≠cio</label>
        <input type="date" id="dataInicio"/>
      </div>
      <div class="field third">
        <label>üìÖ Data Fim</label>
        <input type="date" id="dataFim"/>
      </div>
      <div class="field third">
        <label>üè¢ Empresa</label>
        <select id="filtroEmpresa" title="Fixo: ABC DE VENDAS VILLA GOURMET">
          <option value="">Todas Empresas</option>
        </select>
      </div>
      <div class="field">
        <label>üîç Busca</label>
        <input type="text" id="filtroBusca" placeholder="Buscar produto‚Ä¶ (ex.: Coca, Pizza, √Ågua)"/>
      </div>
      <div class="actions">
        <button id="btnAplicar" class="btn btn-brand">‚öôÔ∏è Aplicar filtros</button>
        <button id="btnLimpar" class="btn btn-ghost">üßπ Limpar</button>
        <div id="miniLoading">
          <span class="dot"></span><span class="dot d2"></span><span class="dot d3"></span>
          <span>Recalculando an√°lises‚Ä¶</span>
        </div>
      </div>
    </section>

    <section class="resumo-geral">
      <div class="kpi">
        <span class="dot" style="background:var(--brand-2)"></span>
        <div>
          <div class="kpi-title">Faturamento</div>
          <div class="kpi-value" id="totalFaturamento">R$ 0,00</div>
        </div>
      </div>
      <div class="kpi">
        <span class="dot" style="background:var(--ok)"></span>
        <div>
          <div class="kpi-title">Lucro</div>
          <div class="kpi-value" id="totalLucro">R$ 0,00</div>
        </div>
      </div>
    </section>

    <canvas id="graficoVendas"></canvas>

    <div class="analise-flex">
      <div id="topVendidos" class="card-analise"></div>
      <div id="maisLucro" class="card-analise"></div>
      <div id="menosLucro" class="card-analise"></div>
    </div>

    <h2 style="margin:18px 0 8px 0">üö´ Produtos Sem Vendas</h2>
    <div id="semVendas" class="card-analise">(Necess√°rio lista completa de produtos para comparar)</div>

    <div id="listaVendas" style="margin-top:18px"></div>
  </div>

  <!-- Popup -->
  <div id="popupOverlay">
    <div id="popupContent">
      <div id="popupClose" onclick="fecharPopup()">&times;</div>
      <h2 id="popupTitle" style="margin:0 0 10px 0"></h2>
      <canvas id="graficoProdutoCanvas"></canvas>
      <canvas id="graficoPizza" style="max-width: 420px; margin-top: 20px; display: none;"></canvas>
      <div id="dadosProdutoTabela"></div>
    </div>
  </div>

<script>
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbz8NEPUpDI0_JZKeqQLrV4JwinN1RVGDs7-a0Rc3lWidxJa4GRin4csMkceAs5XjVOpOg/exec';

let dados = [];
let chartVendas = null;
let chartProduto = null;
let chartPizza = null;
let toqueLongoTimeout = null;

// Utils
const $ = (id)=>document.getElementById(id);
function formatMoeda(v){ return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function formatDataBr(iso){
  if (!iso || !iso.includes('-')) return iso;
  const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`;
}

// ---------- LOADING HELPERS ----------
function showFullLoading(show){
  $('loadingOverlay').style.display = show ? 'grid' : 'none';
}
function showMiniLoading(show){
  $('miniLoading').style.display = show ? 'inline-flex' : 'none';
  $('btnAplicar').disabled = show;
}

// ---------- CORE ----------
async function carregarDados(){
  try{
    const res = await fetch(URL_SCRIPT);
    dados = await res.json();
    preencherFiltros();
    // Datas padr√£o: 1¬∫ dia do m√™s at√© ontem
    const hoje = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    const ontem = new Date(hoje); ontem.setDate(hoje.getDate()-1);
    $('dataInicio').value = primeiroDia.toISOString().split('T')[0];
    $('dataFim').value = ontem.toISOString().split('T')[0];

    // Primeira aplica√ß√£o com loader global
    aplicarFiltros();
  }catch(e){
    console.error(e);
    alert('N√£o foi poss√≠vel carregar os dados. Verifique o endpoint do Apps Script.');
  }finally{
    showFullLoading(false);
  }
}

function preencherFiltros(){
  const empresas = [...new Set(dados.map(d => d.empresa))].sort();
  const sel = $('filtroEmpresa');
  sel.innerHTML = '<option value="">Todas Empresas</option>' + empresas.map(e=>`<option value="${e}">${e}</option>`).join('');
  // Mant√©m compat√≠vel com seu requisito anterior (somente VILLA GOURMET)
  const alvo = 'ABC DE VENDAS VILLA GOURMET';
  if (empresas.includes(alvo)){
    sel.value = alvo;
  }
}

function coletarParametros(){
  return {
    empresa: $('filtroEmpresa').value,
    busca: $('filtroBusca').value.toLowerCase().trim(),
    di: $('dataInicio').value,
    df: $('dataFim').value
  };
}

function aplicarFiltros(){
  showMiniLoading(true);
  // Deixa o mini loader aparecer antes de calcular
  requestAnimationFrame(()=> setTimeout(()=> {
    const {empresa, busca, di, df} = coletarParametros();

    const filt = dados.filter(d=>{
      // Mant√©m a trava de empresa conforme sua especifica√ß√£o anterior
      if (d.empresa !== "ABC DE VENDAS VILLA GOURMET") return false;
      if (busca && !String(d.produto||'').toLowerCase().includes(busca)) return false;
      if (di && d.data < di) return false;
      if (df && d.data > df) return false;
      return true;
    });

    mostrarResumo(filt);
    desenharGrafico(filt, empresa);
    mostrarAnalises(filt);
    listarVendas(filt);

    showMiniLoading(false);
  }, 50));
}

function limparFiltros(){
  $('filtroBusca').value = '';
  // Mant√©m empresa travada se existir
  const alvo = 'ABC DE VENDAS VILLA GOURMET';
  if ([...$('filtroEmpresa').options].some(o=>o.value===alvo)) $('filtroEmpresa').value = alvo; else $('filtroEmpresa').value='';
  // Datas padr√£o novamente
  const hoje = new Date();
  const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  const ontem = new Date(hoje); ontem.setDate(hoje.getDate()-1);
  $('dataInicio').value = primeiroDia.toISOString().split('T')[0];
  $('dataFim').value = ontem.toISOString().split('T')[0];
  aplicarFiltros();
}

// ---------- UI BUILD ----------
function mostrarResumo(filt){
  const fat = filt.reduce((a,c)=>a+(c.faturamento||0),0);
  const luc = filt.reduce((a,c)=>a+(c.lucro||0),0);
  $('totalFaturamento').textContent = formatMoeda(fat);
  $('totalLucro').textContent = formatMoeda(luc);
}

function desenharGrafico(filt, empresaSelecionada){
  if(!empresaSelecionada){
    $('graficoVendas').style.display='none';
    if (chartVendas) { chartVendas.destroy(); chartVendas=null; }
    return;
  }
  const dadosPorData = {};
  filt.forEach(d=> dadosPorData[d.data] = (dadosPorData[d.data]||0) + (d.faturamento||0));

  const labels = Object.keys(dadosPorData).sort((a,b)=> new Date(a)-new Date(b));
  const vals = labels.map(l=>dadosPorData[l]);

  const ctx = $('graficoVendas').getContext('2d');
  if(chartVendas) chartVendas.destroy();
  chartVendas = new Chart(ctx, {
    type:'line',
    data:{
      labels: labels.map(formatDataBr),
      datasets:[{
        label:'Faturamento por dia',
        data: vals,
        borderColor:'#7c5cff',
        backgroundColor:'rgba(124,92,255,.18)',
        fill:true,
        pointRadius:4,
        pointHoverRadius:6
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        title:{display:true, text:'Evolu√ß√£o de Vendas'}
      },
      interaction:{mode:'nearest', axis:'x', intersect:false},
      scales:{
        y:{beginAtZero:true, ticks:{callback:(v)=>formatMoeda(v)}}
      }
    }
  });
  $('graficoVendas').style.display='block';
}

function mostrarAnalises(filt){
  const countByProd = {};
  filt.forEach(d=>{
    const p = d.produto || '(sem nome)';
    if(!countByProd[p]) countByProd[p] = {qtd:0, fat:0, luc:0};
    countByProd[p].qtd += (d.quantidade||0);
    countByProd[p].fat += (d.faturamento||0);
    countByProd[p].luc += (d.lucro||0);
  });
  const arr = Object.entries(countByProd).map(([produto, data])=>({produto, ...data}));
  const topVend = [...arr].sort((a,b)=> b.fat - a.fat).slice(0,5);
  const maisLuc = [...arr].sort((a,b)=> b.luc - a.luc).slice(0,5);
  const menosLuc = [...arr].sort((a,b)=> a.luc - b.luc).slice(0,5);

  $('topVendidos').innerHTML = `<h3>‚≠ê Top Produtos</h3>` + topVend.map(p=>`<p>‚≠ê ${p.produto} ‚Äî ${p.qtd} un / ${formatMoeda(p.fat)}</p>`).join('');
  $('maisLucro').innerHTML   = `<h3>üí∞ Produtos Mais Lucrativos</h3>` + maisLuc.map(p=>`<p>üí∞ ${p.produto} ‚Äî ${formatMoeda(p.luc)}</p>`).join('');
  $('menosLucro').innerHTML  = `<h3>üìâ Produtos Menos Lucrativos</h3>` + menosLuc.map(p=>`<p>üìâ ${p.produto} ‚Äî ${formatMoeda(p.luc)}</p>`).join('');

  const produtosFiltrados = new Set(filt.map(d => d.produto || '(sem nome)'));
  const produtosComVenda = new Set(filt.filter(d => (d.quantidade||0) > 0).map(d => d.produto || '(sem nome)'));
  const naoVendidos = [...produtosFiltrados].filter(p => !produtosComVenda.has(p));

  const container = $('semVendas');
  container.innerHTML = `<h3>‚ùå Nome nas linhas vazias (indicador de erro) (${ $('dataInicio').value } at√© ${ $('dataFim').value })</h3>`;
  naoVendidos.forEach(produto=>{
    const div = document.createElement('div');
    div.textContent = produto; div.style.padding='4px 0';
    div.onclick = ()=> mostrarHistoricoVendasProduto(produto);
    container.appendChild(div);
  });
}

function mostrarHistoricoVendasProduto(produto){
  const vendasAnteriores = dados
    .filter(d => (d.produto||'(sem nome)') === produto && (d.quantidade||0) > 0)
    .map(d => `${formatDataBr(d.data)} ‚Äî ${d.empresa} ‚Äî ${d.quantidade} un ‚Äî ${formatMoeda(d.faturamento)}`);
  if (!vendasAnteriores.length){
    alert(`O produto "${produto}" nunca teve vendas registradas.`);
    return;
  }
  alert(`üìÖ Vendas anteriores de "${produto}":\n\n` + vendasAnteriores.join('\n'));
}

function listarVendas(filt){
  const cont = $('listaVendas');
  cont.innerHTML = '';

  const agrupado = {};
  filt.forEach(d=>{
    if ((d.quantidade||0) > 0){
      const chave = (d.produto||'(sem nome)') + '___' + d.empresa;
      if(!agrupado[chave]) agrupado[chave] = {produto:d.produto||'(sem nome)', empresa:d.empresa, quantidade:0, faturamento:0, lucro:0, detalhes:[]};
      agrupado[chave].quantidade += d.quantidade||0;
      agrupado[chave].faturamento += d.faturamento||0;
      agrupado[chave].lucro += d.lucro||0;
      agrupado[chave].detalhes.push(d);
    }
  });

  const lista = Object.values(agrupado).sort((a,b)=> b.faturamento - a.faturamento);

  if (lista.length){
    const blocoCom = document.createElement('div');
    blocoCom.className = 'bloco-com-vendas';
    blocoCom.innerHTML = `<h3>‚úÖ Produtos com Vendas (Agrupados)</h3>`;
    lista.forEach(p=>{
      const div = document.createElement('div');
      div.style.cursor='pointer';
      div.innerHTML = `<p><strong>${p.produto}</strong> ‚Äî ${p.quantidade} un ‚Äî ${formatMoeda(p.faturamento)} ‚Äî Lucro: ${formatMoeda(p.lucro)}</p>`;
      div.onclick = ()=> exibirGraficoProdutoSelecionado(p.produto, p.empresa);
      blocoCom.appendChild(div);
    });
    cont.appendChild(blocoCom);
  }

  const semVendas = filt.filter(d => (d.quantidade||0) === 0);
  if (semVendas.length){
    const blocoSem = document.createElement('div');
    blocoSem.className = 'bloco-sem-vendas';
    blocoSem.innerHTML = `<h3>‚ö†Ô∏è Produtos Registrados mas com Quantidade 0</h3>`;
    semVendas.forEach(d=>{
      const div = document.createElement('div');
      div.style.cursor='pointer';
      div.innerHTML = `<p>${formatDataBr(d.data)} | ${d.empresa} | <strong>${d.produto||'(sem nome)'}</strong> ‚Äî ${d.quantidade} un ‚Äî ${formatMoeda(d.faturamento)} ‚Äî Lucro: ${formatMoeda(d.lucro)}</p>`;
      div.onclick = ()=> exibirGraficoProdutoSelecionado(d.produto||'(sem nome)', d.empresa);
      blocoSem.appendChild(div);
    });
    cont.appendChild(blocoSem);
  }
}

function exibirGraficoProdutoSelecionado(produto, empresa){
  const di = $('dataInicio').value;
  const df = $('dataFim').value;
  const filtro = dados.filter(d =>
    (d.produto||'(sem nome)') === produto &&
    d.empresa === empresa &&
    (!di || d.data >= di) && (!df || d.data <= df)
  );

  const dadosPorData = {};
  filtro.forEach(d => dadosPorData[d.data] = (dadosPorData[d.data]||0) + (d.faturamento||0));
  const labels = Object.keys(dadosPorData).sort((a,b)=> new Date(a)-new Date(b));
  const valores = labels.map(l=>dadosPorData[l]);

  const ctx = $('graficoProdutoCanvas').getContext('2d');
  if(chartProduto) chartProduto.destroy();
  chartProduto = new Chart(ctx, {
    type:'bar',
    data:{
      labels: labels.map(formatDataBr),
      datasets:[{ label: produto, data: valores, backgroundColor:'rgba(34,211,238,.35)' }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        title:{display:true, text:'Evolu√ß√£o de Vendas'}
      },
      interaction:{mode:'nearest', axis:'x', intersect:false},
      scales:{ y:{beginAtZero:true, ticks:{callback:(v)=>formatMoeda(v)}} }
    }
  });

  $('popupTitle').textContent = `üìä An√°lise do Produto: ${produto}`;
  $('dadosProdutoTabela').innerHTML = filtro.map(d =>
    `<p>${formatDataBr(d.data)} | ${d.empresa} | ${d.quantidade} un | ${formatMoeda(d.faturamento)} | Lucro: ${formatMoeda(d.lucro)}</p>`
  ).join('');

  $('popupOverlay').style.display = 'grid';

  // Pizza por participa√ß√£o
  const totalPeriodo = dados
    .filter(d => d.empresa === empresa && (!di || d.data >= di) && (!df || d.data <= df))
    .reduce((sum,d)=> sum + (d.faturamento||0), 0);
  const totalProduto = filtro.reduce((sum,d)=> sum + (d.faturamento||0), 0);
  const ctxPizza = $('graficoPizza').getContext('2d');
  if(chartPizza) chartPizza.destroy();
  chartPizza = new Chart(ctxPizza, {
    type:'pie',
    data:{ labels:['üí° Esse Produto','Outros Produtos'], datasets:[{ data:[totalProduto, Math.max(0,totalPeriodo-totalProduto)], backgroundColor:['#22d3ee','#64748b'] }] },
    options:{ plugins:{ title:{display:true, text:`Participa√ß√£o no Faturamento: ${ totalPeriodo? ((totalProduto/totalPeriodo)*100).toFixed(1):'0.0'}%`} } }
  });
  $('graficoPizza').style.display='block';
}

function fecharPopup(){
  $('popupOverlay').style.display='none';
  if(chartProduto) chartProduto.destroy();
  if(chartPizza) chartPizza.destroy();
  $('graficoPizza').style.display='none';
}

// ---------- EVENTS ----------
window.onload = ()=>{
  showFullLoading(true);
  carregarDados();

  // Bot√µes
  $('btnAplicar').addEventListener('click', (e)=>{ e.preventDefault(); aplicarFiltros(); });
  $('btnLimpar').addEventListener('click', (e)=>{ e.preventDefault(); limparFiltros(); });

  // Tecla Enter na busca -> aplica
  $('filtroBusca').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ aplicarFiltros(); } });
};
</script>
</body>
</html>
