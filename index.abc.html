<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>ABC de Vendas ‚Ä¢ Grupo DV</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#2563eb; --ok:#16a34a; --warn:#b45309; --danger:#ef4444;
    --radius:16px; --shadow:0 12px 28px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:16px;padding:16px 20px;background:#fff;border-bottom:1px solid var(--line)}
  header img{height:56px}
  header h1{margin:0;font-size:1.25rem;font-weight:700;letter-spacing:.2px}
  .container{max-width:1200px;margin:26px auto;padding:0 16px}
  .grid{display:grid;gap:16px}
  .filters{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:900px){.filters{grid-template-columns:1fr 1fr}.kpis{grid-template-columns:1fr 1fr}}
  @media (max-width:600px){.filters{grid-template-columns:1fr}.kpis{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:16px}
  label{font-weight:600;font-size:.85rem;color:#111827;margin-bottom:6px;display:block}
  select,input[type="date"],input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:.95rem}
  .kpi{padding:16px}
  .kpi h3{margin:0 0 6px;font-size:.8rem;color:var(--muted);font-weight:600}
  .kpi p{margin:0;font-size:1.4rem;font-weight:800}
  .section-title{margin:18px 4px 10px;font-size:.95rem;color:#111827;font-weight:700}
  #graficoVendas{display:none;padding:16px}
  .lists{grid-template-columns:repeat(3,minmax(0,1fr))}
  .item{padding:10px 12px;border:1px dashed var(--line);border-radius:12px;margin-bottom:10px;background:#fff}
  .muted{color:var(--muted)}
  .ok{background:#ecfdf5;border-left:6px solid var(--ok)}
  .warn{background:#fef3c7;border-left:6px solid var(--warn)}
  .danger{background:#fee2e2;border-left:6px solid var(--danger)}
  .loader{display:flex;align-items:center;justify-content:center;gap:10px;padding:28px;color:var(--muted)}
  .spinner{width:18px;height:18px;border:3px solid var(--line);border-top-color:var(--brand);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .empty,.error{padding:18px;margin:8px 0;border-radius:12px;border:1px solid var(--line);background:#fff}
  .error{border-color:#fecaca;background:#fff1f2;color:#991b1b}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{font-size:.75rem;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
</style>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Grupo DV">
  <h1>ABC de Vendas ‚Ä¢ Grupo DV</h1>
</header>

<div class="container">
  <!-- Filtros -->
  <div class="grid filters">
    <div class="card pad">
      <label>üè¢ Empresa</label>
      <select id="filtroEmpresa"><option value="">Todas</option></select>
    </div>
    <div class="card pad">
      <label>üîç Busca</label>
      <input id="filtroBusca" type="text" placeholder="Produto..." />
    </div>
    <div class="card pad">
      <label>üìÖ In√≠cio</label>
      <input id="dataInicio" type="date" />
    </div>
    <div class="card pad">
      <label>üìÖ Fim</label>
      <input id="dataFim" type="date" />
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid kpis" style="margin-top:16px">
    <div class="card kpi">
      <h3>Faturamento</h3>
      <p id="kpiFat">R$ 0,00</p>
    </div>
    <div class="card kpi">
      <h3>Lucro</h3>
      <p id="kpiLuc">R$ 0,00</p>
    </div>
  </div>

  <!-- Gr√°fico -->
  <div class="card" id="wrapGraf">
    <canvas id="graficoVendas"></canvas>
  </div>

  <!-- Listas -->
  <div class="section-title">An√°lises</div>
  <div class="grid lists">
    <div class="card pad"><h3 class="muted" style="margin:0 0 10px">‚≠ê Top Produtos</h3><div id="topVendidos"></div></div>
    <div class="card pad"><h3 class="muted" style="margin:0 0 10px">üí∞ Mais Lucrativos</h3><div id="maisLucro"></div></div>
    <div class="card pad"><h3 class="muted" style="margin:0 0 10px">üìâ Menos Lucrativos</h3><div id="menosLucro"></div></div>
  </div>

  <div class="section-title">Registros</div>
  <div class="card pad">
    <div id="statusBox" class="loader"><div class="spinner"></div> Carregando dados‚Ä¶</div>
    <div id="listaVendas" style="display:none"></div>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbxu0HjXsbvXr9OGYDAEfN8Kqyle4d2GFb26wu8aAcAtfM-RkcILV9AywDjf1Fu8rW_NwQ/exec';

/* =================== ESTADO =================== */
let RAW = [];        // payload.dados
let chartVendas = null;

/* =================== UTILS =================== */
const $$ = sel => document.querySelector(sel);
const BRL = n => (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const dBR = iso => !iso ? '' : iso.split('-').reverse().join('/');

/* =================== LOAD =================== */
async function fetchABC(){
  const box = $$('#statusBox');
  box.className='loader';
  box.innerHTML = '<div class="spinner"></div> Carregando dados‚Ä¶';

  try{
    const res = await fetch(URL_SCRIPT, { method:'GET' });
    const txt = await res.text(); // para diagnosticar erros de CORS/HTML
    let json;
    try { json = JSON.parse(txt); } catch(e){ throw new Error('Resposta inv√°lida do servidor:\n' + txt.slice(0,300)); }

    // Aceita {ok,dados} ou array puro
    const arr = Array.isArray(json) ? json : (json.dados || []);
    if (!arr.length) {
      box.className='empty';
      box.textContent = 'Sem dados para o per√≠odo.';
      return [];
    }
    box.style.display='none';
    $$('#listaVendas').style.display='block';
    return arr;
  }catch(err){
    box.className='error';
    box.textContent = 'Erro ao carregar: ' + (err.message || err);
    console.error(err);
    return [];
  }
}

function preencherEmpresas(arr){
  const empresas = [...new Set(arr.map(d=>d.empresa))].sort();
  const sel = $$('#filtroEmpresa');
  sel.innerHTML = '<option value="">Todas</option>' + empresas.map(e=>`<option value="${e}">${e}</option>`).join('');
}

function setDatasPorFaixa(arr){
  const datas = arr.map(d=>d.data).filter(Boolean).sort();
  if (!datas.length) return;
  const min = datas[0];
  const max = datas[datas.length-1];
  $$('#dataInicio').value = min;
  $$('#dataFim').value    = max;
}

/* =================== RENDER =================== */
function aplicar(){
  const empresa = $$('#filtroEmpresa').value;
  const busca = ($$('#filtroBusca').value||'').toLowerCase();
  const di = $$('#dataInicio').value;
  const df = $$('#dataFim').value;

  const F = RAW.filter(r=>{
    if (empresa && r.empresa !== empresa) return false;
    if (busca && !String(r.produto||'').toLowerCase().includes(busca)) return false;
    if (di && r.data < di) return false;
    if (df && r.data > df) return false;
    return true;
  });

  // KPIs
  const fat = F.reduce((s,x)=>s+(x.faturamento||0),0);
  const luc = F.reduce((s,x)=>s+(x.lucro||0),0);
  $$('#kpiFat').textContent = BRL(fat);
  $$('#kpiLuc').textContent = BRL(luc);

  // Gr√°fico di√°rio (se empresa selecionada)
  desenharGrafico(F, !!empresa);

  // An√°lises
  const byProd = {};
  F.forEach(x=>{
    const p = x.produto||'';
    if (!byProd[p]) byProd[p]={q:0,f:0,l:0};
    byProd[p].q += (x.quantidade||0);
    byProd[p].f += (x.faturamento||0);
    byProd[p].l += (x.lucro||0);
  });
  const arr = Object.entries(byProd).map(([produto,v])=>({produto,...v}));

  renderLista('#topVendidos',   [...arr].sort((a,b)=>b.f-a.f).slice(0,5), p=>`‚≠ê ${p.produto} ‚Äî ${p.q} un ‚Ä¢ ${BRL(p.f)}`);
  renderLista('#maisLucro',     [...arr].sort((a,b)=>b.l-a.l).slice(0,5), p=>`üí∞ ${p.produto} ‚Äî ${BRL(p.l)}`);
  renderLista('#menosLucro',    [...arr].sort((a,b)=>a.l-b.l).slice(0,5), p=>`üìâ ${p.produto} ‚Äî ${BRL(p.l)}`);

  // Tabela simples (agrupado por produto/empresa)
  const agrup = {};
  F.forEach(x=>{
    const key = `${x.produto}__${x.empresa}`;
    if (!agrup[key]) agrup[key]={produto:x.produto,empresa:x.empresa,q:0,f:0,l:0,rows:[]};
    agrup[key].q += (x.quantidade||0);
    agrup[key].f += (x.faturamento||0);
    agrup[key].l += (x.lucro||0);
    agrup[key].rows.push(x);
  });
  const lista = Object.values(agrup).sort((a,b)=>b.f-a.f);

  const cont = $$('#listaVendas');
  cont.innerHTML = '';
  lista.forEach(p=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<strong>${p.produto}</strong> <span class="muted">‚Ä¢ ${p.empresa}</span><br>
      ${p.q} un ‚Ä¢ ${BRL(p.f)} ‚Ä¢ Lucro: ${BRL(p.l)}`;
    cont.appendChild(div);
  });

  if (!lista.length){
    $$('#statusBox').style.display='block';
    $$('#statusBox').className='empty';
    $$('#statusBox').textContent='Nenhum registro com os filtros atuais.';
  }
}

function renderLista(sel, arr, fmt){
  const el = document.querySelector(sel);
  el.innerHTML = arr.map(x=>`<div class="item">${fmt(x)}</div>`).join('') || '<div class="muted">‚Äî</div>';
}

function desenharGrafico(F, mostrar){
  const canvas = $$('#graficoVendas');
  if (!mostrar){
    canvas.style.display='none';
    if (chartVendas) chartVendas.destroy();
    return;
  }
  const porDia = {};
  F.forEach(x=> porDia[x.data] = (porDia[x.data]||0) + (x.faturamento||0));
  const labels = Object.keys(porDia).sort();
  const vals = labels.map(d=>porDia[d]);

  if (chartVendas) chartVendas.destroy();
  chartVendas = new Chart(canvas.getContext('2d'), {
    type:'line',
    data:{ labels:labels.map(dBR), datasets:[{ label:'Faturamento por dia', data:vals, fill:true, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', pointRadius:4, pointHoverRadius:6 }] },
    options:{ responsive:true, plugins:{ legend:{display:false}, title:{display:true,text:'Evolu√ß√£o de Vendas'} } }
  });
  canvas.style.display='block';
}

/* =================== INIT =================== */
window.addEventListener('load', async ()=>{
  RAW = await fetchABC();
  if (!RAW.length) return;
  preencherEmpresas(RAW);
  setDatasPorFaixa(RAW);
  aplicar();

  ['change','input'].forEach(evt=>{
    $$('#filtroEmpresa').addEventListener(evt, aplicar);
    $$('#filtroBusca').addEventListener(evt, aplicar);
    $$('#dataInicio').addEventListener(evt, aplicar);
    $$('#dataFim').addEventListener(evt, aplicar);
  });
});
</script>
</body>
</html>
