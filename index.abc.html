<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel ABC de Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial, sans-serif;background:#f7f7f7;margin:0;padding:0;font-size:14px}
    header{background:#fff;padding:20px;display:flex;align-items:center;border-bottom:1px solid #ccc;gap:10px}
    header img{height:60px}
    header h1{margin:0;font-size:1.6em;font-weight:bold;color:#000;flex-grow:1;text-align:center}
    .container{padding:20px;max-width:100%;margin:auto}
    .filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
    .filters label{display:flex;flex-direction:column;font-weight:bold;color:#333;font-size:.9em;flex:1 1 200px}
    .filters select,.filters input{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:.95em}
    .resumo-geral{background:#fff;padding:15px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,.05);display:flex;gap:30px;font-weight:bold}
    canvas{background:#fff;border-radius:12px;padding:20px;margin-bottom:30px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    .analise-flex{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:30px}
    .card-analise{background:#fff;padding:15px;border-radius:12px;flex:1 1 100%;box-shadow:0 4px 10px rgba(0,0,0,.05);min-width:unset}
    .card-analise h3{margin:0 0 10px;font-size:1.1em;color:#2c3e50}
    .bloco-com-vendas{background:#e9f9f0;border-left:6px solid #27ae60;padding:15px;border-radius:12px;margin-bottom:20px}
    .bloco-sem-vendas{background:#fdecea;border-left:6px solid #c0392b;padding:15px;border-radius:12px;margin-bottom:20px}
    #graficoVendas{display:none;max-width:700px;height:300px !important;margin:0 auto 30px}
    #menuFiltroVenda,#analises div{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    #listaVendas div{background:#fff;margin-bottom:10px;padding:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.05);cursor:pointer}
    #popupOverlay{position:fixed;inset:0;width:100vw;height:100vh;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    #popupContent{position:relative;background:#fff;padding:20px;border-radius:10px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto}
    #popupClose{position:absolute;top:10px;right:15px;font-size:22px;font-weight:bold;color:#333;cursor:pointer;z-index:10}
    #graficoProdutoSelecionado{display:none;background:#fff;margin-top:20px;border-radius:12px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    *{box-sizing:border-box;max-width:100%;overflow-x:hidden}
    html,body{width:100%;max-width:100%;overflow-x:hidden}
    .filters{flex-direction:column;gap:15px}
    .card-analise{flex:1 1 100%;min-width:unset}
  </style>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo CB Systems">
  <h1 id="tituloPainel">ABC DE VENDAS GRUPO DV</h1>
</header>

<div class="container">
  <div class="filters">
    <label>üìÖ Data In√≠cio: <input type="date" id="dataInicio" /></label>
    <label>üìÖ Data Fim: <input type="date" id="dataFim" /></label>
    <label>üè¢ Empresa:
      <select id="filtroEmpresa">
        <option value="">Todas Empresas</option>
      </select>
    </label>
    <label>üîç Busca: <input type="text" id="filtroBusca" placeholder="Buscar produto..." /></label>
  </div>

  <div class="resumo-geral">
    <div>üìä Faturamento: <span id="totalFaturamento">R$ 0,00</span></div>
    <div>üí∞ Lucro: <span id="totalLucro">R$ 0,00</span></div>
  </div>

  <div id="popupOverlay">
    <div id="popupContent">
      <div id="popupClose" onclick="fecharPopup()">&times;</div>
      <h2 id="popupTitle"></h2>
      <canvas id="graficoProdutoCanvas"></canvas>
      <canvas id="graficoPizza" style="max-width: 400px; margin-top: 20px; display:none;"></canvas>
      <div id="dadosProdutoTabela"></div>
    </div>
  </div>

  <canvas id="graficoVendas"></canvas>

  <div class="analise-flex">
    <div id="topVendidos" class="card-analise"></div>
    <div id="maisLucro" class="card-analise"></div>
    <div id="menosLucro" class="card-analise"></div>
  </div>

  <h2>üö´ Produtos Sem Vendas</h2>
  <div id="semVendas">(Necess√°rio lista completa de produtos para comparar)</div>

  <div id="listaVendas"></div>
</div>

<script>
/* ======= CONFIG ======= */
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbz8NEPUpDI0_JZKeqQLrV4JwinN1RVGDs7-a0Rc3lWidxJa4GRin4csMkceAs5XjVOpOg/exec';
// O WebApp j√° retorna apenas o m√™s atual. Par√¢metros extras s√£o opcionais (empresa, classe, etc).

/* ======= ESTADO ======= */
let dados = [];        // lista de registros vindos do WebApp (payload.dados)
let chartVendas = null;
let chartProduto = null;
let chartPizza = null;
let toqueLongoTimeout = null;

/* ======= UTILS ======= */
const formatMoeda = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function formatDataBr(iso){
  if (!iso || !iso.includes('-')) return iso;
  const [y,m,d] = iso.split('-');
  return `${d}/${m}/${y}`;
}

/* ======= LOAD ======= */
async function carregarDados(){
  const res = await fetch(URL_SCRIPT);     // m√™s atual por padr√£o
  const json = await res.json();
  if (!json || !json.ok) {
    alert('Falha ao carregar dados do ABC.');
    return;
  }
  dados = json.dados || [];

  preencherFiltros();
  aplicarFiltros();
}

function preencherFiltros(){
  const empresas = [...new Set(dados.map(d => d.empresa))].sort();
  const sel = document.getElementById('filtroEmpresa');
  sel.innerHTML = '<option value="">Todas Empresas</option>' + empresas.map(e => `<option value="${e}">${e}</option>`).join('');
}

/* ======= FILTROS / VIEW ======= */
function aplicarFiltros(){
  const empresaSel = document.getElementById('filtroEmpresa').value;
  const busca = document.getElementById('filtroBusca').value.toLowerCase();
  const di = document.getElementById('dataInicio').value; // yyyy-mm-dd
  const df = document.getElementById('dataFim').value;    // yyyy-mm-dd

  const filt = dados.filter(d=>{
    if (empresaSel && d.empresa !== empresaSel) return false;
    if (busca && !String(d.produto||'').toLowerCase().includes(busca)) return false;
    if (di && d.data < di) return false; // d.data tamb√©m √© yyyy-mm-dd
    if (df && d.data > df) return false;
    return true;
  });

  mostrarResumo(filt);
  desenharGrafico(filt, empresaSel);
  mostrarAnalises(filt);
  listarVendas(filt);
}

function mostrarResumo(filt){
  const fat = filt.reduce((a,c)=>a+(c.faturamento||0),0);
  const luc = filt.reduce((a,c)=>a+(c.lucro||0),0);
  document.getElementById('totalFaturamento').textContent = formatMoeda(fat);
  document.getElementById('totalLucro').textContent       = formatMoeda(luc);
}

function desenharGrafico(filt, empresaSelecionada){
  const canvas = document.getElementById('graficoVendas');
  if (!empresaSelecionada){
    canvas.style.display='none';
    if (chartVendas) chartVendas.destroy();
    return;
  }

  const dadosPorData = {};
  filt.forEach(d=>{
    dadosPorData[d.data] = (dadosPorData[d.data]||0) + (d.faturamento||0);
  });

  const labels = Object.keys(dadosPorData).sort((a,b)=> a.localeCompare(b));
  const vals = labels.map(l=>dadosPorData[l]);

  const ctx = canvas.getContext('2d');
  if(chartVendas) chartVendas.destroy();

  chartVendas = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.map(formatDataBr),
      datasets: [{
        label: 'Faturamento por dia',
        data: vals,
        borderColor: '#3498db',
        backgroundColor: 'rgba(52,152,219,0.2)',
        fill: true,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      interaction: { mode:'nearest', axis:'x', intersect:false },
      plugins: {
        legend: { display:false },
        title: { display:true, text:'Evolu√ß√£o de Vendas' },
        tooltip: { callbacks: {
          label: (ctx)=> 'üí∞ ' + (ctx.parsed.y||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
        }}
      }
    }
  });

  canvas.style.display = 'block';
}

function mostrarAnalises(filt){
  const byProd = {};
  filt.forEach(d=>{
    const p = d.produto||'';
    if (!byProd[p]) byProd[p] = { qtd:0, fat:0, luc:0 };
    byProd[p].qtd += (d.quantidade||0);
    byProd[p].fat += (d.faturamento||0);
    byProd[p].luc += (d.lucro||0);
  });

  const arr = Object.entries(byProd).map(([produto, v]) => ({ produto, ...v }));
  const topVend  = [...arr].sort((a,b)=>b.fat-a.fat).slice(0,5);
  const maisLuc  = [...arr].sort((a,b)=>b.luc-a.luc).slice(0,5);
  const menosLuc = [...arr].sort((a,b)=>a.luc-b.luc).slice(0,5);

  document.getElementById('topVendidos').innerHTML =
    `<h3>‚≠ê Top Produtos</h3>` + topVend.map(p=>`<p>‚≠ê ${p.produto} ‚Äî ${p.qtd} un / ${formatMoeda(p.fat)}</p>`).join('');
  document.getElementById('maisLucro').innerHTML =
    `<h3>üí∞ Produtos Mais Lucrativos</h3>` + maisLuc.map(p=>`<p>üí∞ ${p.produto} ‚Äî ${formatMoeda(p.luc)}</p>`).join('');
  document.getElementById('menosLucro').innerHTML =
    `<h3>üìâ Produtos Menos Lucrativos</h3>` + menosLuc.map(p=>`<p>üìâ ${p.produto} ‚Äî ${formatMoeda(p.luc)}</p>`).join('');

  // ‚ÄúSem vendas‚Äù (apenas dentro do conjunto filtrado)
  const produtosFiltrados = new Set(filt.map(d=>d.produto));
  const produtosComVenda  = new Set(filt.filter(d=>(d.quantidade||0)>0).map(d=>d.produto));
  const naoVendidos = [...produtosFiltrados].filter(p=>!produtosComVenda.has(p));

  const container = document.getElementById('semVendas');
  container.innerHTML = `<h3>‚ùå Nome nas linhas vazias (indicador de erro) (${document.getElementById('dataInicio').value} at√© ${document.getElementById('dataFim').value})</h3>`;
  naoVendidos.forEach(produto=>{
    const div = document.createElement('div');
    div.textContent = produto;
    div.style.cursor='pointer';
    div.style.color='#c0392b';
    div.style.padding='4px 0';
    div.onclick = ()=> mostrarHistoricoVendasProduto(produto);
    container.appendChild(div);
  });
}

function mostrarHistoricoVendasProduto(produto){
  const di = document.getElementById('dataInicio').value;
  const df = document.getElementById('dataFim').value;
  const vendasAnteriores = dados
    .filter(d=> d.produto===produto && (!di || d.data>=di) && (!df || d.data<=df) && (d.quantidade||0)>0)
    .map(d=> `${formatDataBr(d.data)} ‚Äî ${d.empresa} ‚Äî ${d.quantidade} un ‚Äî ${formatMoeda(d.faturamento)}`);

  if (!vendasAnteriores.length){
    alert(`O produto "${produto}" n√£o teve vendas no per√≠odo selecionado.`);
    return;
  }
  alert(`üìÖ Vendas de "${produto}":\n\n` + vendasAnteriores.join('\n'));
}

function listarVendas(filt){
  const cont = document.getElementById('listaVendas');
  cont.innerHTML = '';

  const agrupado = {};
  filt.forEach(d=>{
    if ((d.quantidade||0) > 0){
      const chave = d.produto + '___' + d.empresa;
      if (!agrupado[chave]){
        agrupado[chave] = { produto:d.produto, empresa:d.empresa, quantidade:0, faturamento:0, lucro:0, detalhes:[] };
      }
      agrupado[chave].quantidade  += (d.quantidade||0);
      agrupado[chave].faturamento += (d.faturamento||0);
      agrupado[chave].lucro       += (d.lucro||0);
      agrupado[chave].detalhes.push(d);
    }
  });

  const lista = Object.values(agrupado).sort((a,b)=>b.faturamento-a.faturamento);

  if (lista.length){
    const blocoCom = document.createElement('div');
    blocoCom.className='bloco-com-vendas';
    blocoCom.innerHTML = `<h3>‚úÖ Produtos com Vendas (Agrupados)</h3>`;
    lista.forEach(p=>{
      const div = document.createElement('div');
      div.innerHTML = `<p><strong>${p.produto}</strong> ‚Äî ${p.quantidade} un ‚Äî ${formatMoeda(p.faturamento)} ‚Äî Lucro: ${formatMoeda(p.lucro)}</p>`;
      div.onclick = ()=> exibirGraficoProdutoSelecionado(p.produto, p.empresa);
      blocoCom.appendChild(div);
    });
    cont.appendChild(blocoCom);
  }

  const semVendas = filt.filter(d=> (d.quantidade||0) === 0);
  if (semVendas.length){
    const blocoSem = document.createElement('div');
    blocoSem.className='bloco-sem-vendas';
    blocoSem.innerHTML = `<h3>‚ö†Ô∏è Produtos Registrados mas com Quantidade 0</h3>`;
    semVendas.forEach(d=>{
      const div = document.createElement('div');
      div.innerHTML = `<p>${formatDataBr(d.data)} | ${d.empresa} | <strong>${d.produto}</strong> ‚Äî ${d.quantidade} un ‚Äî ${formatMoeda(d.faturamento)} ‚Äî Lucro: ${formatMoeda(d.lucro)}</p>`;
      div.onclick = ()=> exibirGraficoProdutoSelecionado(d.produto, d.empresa);
      blocoSem.appendChild(div);
    });
    cont.appendChild(blocoSem);
  }
}

/* ======= POPUP PRODUTO ======= */
function fecharPopup(){
  document.getElementById('popupOverlay').style.display='none';
  if (chartProduto) chartProduto.destroy();
  if (chartPizza) chartPizza.destroy();
  document.getElementById('graficoPizza').style.display='none';
}

function exibirGraficoProdutoSelecionado(produto, empresa){
  const di = document.getElementById('dataInicio').value;
  const df = document.getElementById('dataFim').value;

  const filtro = dados.filter(d =>
    d.produto===produto && d.empresa===empresa &&
    (!di || d.data>=di) && (!df || d.data<=df)
  );

  const porData = {};
  filtro.forEach(d => porData[d.data] = (porData[d.data]||0) + (d.faturamento||0));
  const labels = Object.keys(porData).sort((a,b)=>a.localeCompare(b));
  const valores = labels.map(l=>porData[l]);

  const ctx = document.getElementById('graficoProdutoCanvas').getContext('2d');
  if (chartProduto) chartProduto.destroy();
  chartProduto = new Chart(ctx, {
    type:'bar',
    data:{ labels:labels.map(formatDataBr), datasets:[{ label:produto, data:valores, backgroundColor:'rgba(46,204,113,0.7)' }] },
    options:{
      responsive:true,
      interaction:{ mode:'nearest', axis:'x', intersect:false },
      plugins:{
        legend:{ display:false },
        title:{ display:true, text:'Evolu√ß√£o de Vendas' },
        tooltip:{ callbacks:{ label:(ctx)=> 'üí∞ ' + (ctx.parsed.y||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) } }
      },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  document.getElementById('popupTitle').textContent = `üìä An√°lise do Produto: ${produto}`;
  const tabela = filtro.map(d => `<p>${formatDataBr(d.data)} | ${d.empresa} | ${d.quantidade} un | ${formatMoeda(d.faturamento)} | Lucro: ${formatMoeda(d.lucro)}</p>`).join('');
  document.getElementById('dadosProdutoTabela').innerHTML = tabela;

  const canvas = document.getElementById('graficoProdutoCanvas');

  function abrirGraficoPizza(){
    const totalPeriodo = dados
      .filter(d => d.empresa===empresa && (!di || d.data>=di) && (!df || d.data<=df))
      .reduce((s,d)=> s + (d.faturamento||0), 0);

    const totalProduto = filtro.reduce((s,d)=> s + (d.faturamento||0), 0);
    const porcentagem = totalPeriodo ? (totalProduto/totalPeriodo)*100 : 0;

    const ctxPizza = document.getElementById('graficoPizza').getContext('2d');
    if (chartPizza) chartPizza.destroy();
    chartPizza = new Chart(ctxPizza, {
      type:'pie',
      data:{ labels:['üí° Esse Produto','Outros Produtos'], datasets:[{ data:[totalProduto, Math.max(totalPeriodo-totalProduto,0)], backgroundColor:['#27ae60','#bdc3c7'] }] },
      options:{ plugins:{ title:{ display:true, text:`Participa√ß√£o no Faturamento: ${porcentagem.toFixed(1)}%` } } }
    });
    document.getElementById('graficoPizza').style.display='block';
  }

  canvas.addEventListener('dblclick', abrirGraficoPizza);
  canvas.addEventListener('touchstart', ()=> toqueLongoTimeout = setTimeout(abrirGraficoPizza, 600));
  canvas.addEventListener('touchend', ()=> clearTimeout(toqueLongoTimeout));
  canvas.addEventListener('touchmove', ()=> clearTimeout(toqueLongoTimeout));

  document.getElementById('popupOverlay').style.display='flex';
}

/* ======= INIT ======= */
window.onload = () => {
  // m√™s atual por padr√£o
  const hoje = new Date();
  const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  const ontem = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() - 1);
  document.getElementById('dataInicio').value = primeiroDia.toISOString().split('T')[0];
  document.getElementById('dataFim').value     = ontem.toISOString().split('T')[0];

  carregarDados();
  document.getElementById('filtroEmpresa').addEventListener('change', aplicarFiltros);
  document.getElementById('dataInicio').addEventListener('change', aplicarFiltros);
  document.getElementById('dataFim').addEventListener('change', aplicarFiltros);
  document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);
};
</script>
</body>
</html>
