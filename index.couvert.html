<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Painel • Couvert Mercatto 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#f4f6f8; --card:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
         --green:#16a34a; --red:#ef4444; --radius:16px; --shadow:0 14px 34px rgba(2,6,23,.08); }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--text)}
  header{background:#0b1220;color:#fff;padding:14px 20px;display:flex;align-items:center}
  header h1{font-size:18px;margin:0;font-weight:800}
  .wrap{margin:12px auto;padding:0 12px;width:100%;max-width:100%}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .kpi h3{margin:0 0 4px;font-size:14px;color:var(--muted)}
  .kpi .val{font-size:24px;font-weight:800}
  .muted{color:var(--muted)}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{border-bottom:1px solid var(--line);padding:12px 10px;text-align:left}
  .table tr.clickable{cursor:pointer}
  .table th{font-size:11px;color:var(--muted);text-transform:uppercase}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
  .lucr{background:#eafff0;color:#065f46;border:1px solid #bbf7d0}
  .prej{background:#ffecec;color:#7f1d1d;border:1px solid #fecaca}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;cursor:pointer;font-weight:600}
  .chip.active{background:#0b1220;color:#fff;border-color:#0b1220}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,0.85);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#0b1220;z-index:100}
  /* MODAL bottom sheet */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;z-index:120}
  .sheet{position:absolute;left:0;right:0;bottom:0;background:#fff;border-radius:20px 20px 0 0;border:1px solid var(--line);box-shadow:var(--shadow);max-height:85vh;display:flex;flex-direction:column}
  .sheet header{background:#fff;color:var(--text);padding:12px 16px;border-bottom:1px solid var(--line);border-radius:20px 20px 0 0}
  .sheet header h3{margin:0;font-size:16px;font-weight:800}
  .sheet header small{color:var(--muted)}
  .sheet .content{overflow:auto;padding:10px 12px}
  .sheet .close{position:absolute;right:12px;top:10px}
  .divider{height:1px;background:var(--line);margin:8px 0}
  /* mobile first (cards) */
  @media(max-width:768px){
    .table, .table thead{display:none}
    #tblPagamentos tbody{display:grid;gap:10px}
    #tblPagamentos tbody tr{display:flex;flex-direction:row;align-items:center;justify-content:space-between;
      border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fff}
    #tblPagamentos tbody tr .info{display:flex;flex-direction:column;gap:6px}
    .pill-supplier{font-weight:700}
    .pill-sub{font-size:12px;color:var(--muted)}
    .val-right{font-weight:800}
    .chev{font-size:20px;color:#94a3b8;margin-left:8px}
  }
</style>
</head>
<body>
<header><h1>Painel de Arrecadação x Pagamentos</h1></header>

<div id="loading">⏳ Carregando dados…</div>

<div class="wrap">
  <div class="card">
    <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:center">
      <div><label>Data início: <input type="date" id="fDataIni"></label></div>
      <div><label>Data fim: <input type="date" id="fDataFim"></label></div>
      <button class="btn" id="btnAplicar">Aplicar</button>
    </div>
    <div style="margin-top:10px">
      <strong>Empresas:</strong>
      <div id="chipsEmpresas" class="chips"></div>
      <div id="empLoadMsg" class="muted" style="display:none">Carregando outras empresas em segundo plano…</div>
    </div>
  </div>

  <div class="grid cols-3">
    <div class="card kpi">
      <div>
        <h3>Arrecadação (Couvert)</h3>
        <div class="val" id="kArrecadacao">⏳ carregando…</div>
        <div id="abcStatus" class="muted" style="font-size:12px"></div>
      </div>
    </div>
    <div class="card kpi">
      <div><h3>Pagamentos</h3><div class="val" id="kPagamentos">R$ 0,00</div></div>
    </div>
    <div class="card kpi">
      <div><h3>Resultado</h3><div class="val" id="kResultado">R$ 0,00 <span id="badgeResult" class="badge lucr">LUCRO</span></div></div>
    </div>
  </div>

  <div class="card">
    <h3>Resumo por Empresa</h3>
    <table class="table" id="tblResumoEmp">
      <thead><tr><th>Empresa</th><th>Arrecadação</th><th>Pagamentos</th><th>Resultado</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Pagamentos (detalhes)</h3>
    <table class="table" id="tblPagamentos">
      <thead><tr><th>Data</th><th>Empresa</th><th>Fornecedor</th><th>Valor</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="msgEmpty" class="muted" style="display:none;margin-top:8px">Nenhum pagamento encontrado nesse período/empresa.</div>
  </div>
</div>

<!-- MODAL / BOTTOM SHEET -->
<div class="modal" id="modal">
  <div class="sheet" style="left:0;right:0;">
    <button class="btn close" onclick="closeModal()">Fechar</button>
    <header>
      <h3 id="mTitle">Histórico</h3>
      <small id="mSub"></small>
    </header>
    <div class="content" id="mBody">
      <!-- preenche via JS -->
    </div>
  </div>
</div>

<script>
/* === URLs reais === */
const SHEET_API = "https://script.google.com/macros/s/AKfycbyUvPTmmfLpAWIA9-zW6i6rYwkTQq7LED8gjdx205twpJv1zCKiyhByjXM7sJ-zIue-hQ/exec";
const ABC_URL   = "https://script.google.com/macros/s/AKfycbxu0HjXsbvXr9OGYDAEfN8Kqyle4d2GFb26wu8aAcAtfM-RkcILV9AywDjf1Fu8rW_NwQ/exec";

/* === STATE === */
const ANO = 2025;
const DEFAULT_EMPRESA = "mercatto";

let pagamentosAll = [];
let abcAll = [];
let empresas = [];
let empresasSelecionadas = new Set();
let rangeAtual = {ini:null, fim:null};
let abcLoaded = false;

/* === HELPERS === */
const $ = (q)=>document.querySelector(q);
function brl(v){return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function parseISO(d){return new Date(d+"T00:00:00");}
function inRange(d,a,b){return (!a||d>=a) && (!b||d<=b);}
function uniq(a){return [...new Set(a)].filter(Boolean).sort();}
function containsCouvert(item){
  const p=String(item.produto||"").toLowerCase();
  if(!p.includes("couvert")) return false;
  const ex=["couvert do villa","couvert delicia","couvert mercatto"];
  return !ex.some(x=>p.includes(x));
}
function cleanNumber(v){
  if(v==null || v==="") return 0;
  if(typeof v==="number") return v;
  const s=String(v).replace(/[R$\s]/g,"").replace(/\./g,"").replace(",",".");
  return parseFloat(s)||0;
}
function fromLiquiToISO(s){
  if(!s) return "";
  const d = new Date(s);
  if(isNaN(d)) return String(s).slice(0,10);
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
}
const monthPt=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
function ymKey(s){const d=new Date(s); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;}
function ymLabel(k){const [y,m]=k.split("-"); return `${monthPt[Number(m)-1]}/${y}`;}

/* === FETCHERS === */
async function fetchPagamentos(){
  const r=await fetch(`${SHEET_API}?action=listAno&ano=${ANO}`);
  if(!r.ok) throw new Error("Pagamentos HTTP "+r.status);
  const js=await r.json();
  const list = Array.isArray(js) ? js : (js.registros || []);
  pagamentosAll = list.map(p=>({
    empresa: p.empresa || p.Empresa || "",
    fornecedor: p.fornecedor || p["Cliente / Fornecedor"] || "",
    data_pagamento: p.data_pagamento || fromLiquiToISO(p.Liquidação || p.Liquidacao || p.liquidacao),
    valor: cleanNumber(p.valor ?? p["Valor Líquido"] ?? p["Valor Bruto"] ?? 0),
    meio_pagamento: p.meio_pagamento || p["Meio de Pagamento"] || "",
    historico: p.historico || p["Histórico"] || ""
  }));
}
async function fetchABC(){
  const r=await fetch(ABC_URL);
  if(!r.ok) throw new Error("ABC HTTP "+r.status);
  const arr=await r.json();
  abcAll = arr.filter(o=>{
    const d = new Date(o.data || o.DATA || "");
    if(isNaN(d)) return false;
    return d.getFullYear()===ANO && containsCouvert(o);
  }).map(o=>({
    data: o.data || o.DATA,
    empresa: o.empresa || o.EMPRESA || "",
    faturamento: cleanNumber(o.faturamento || o.FATURAMENTO || o.valor || 0),
    produto: o.produto || o.PRODUTO || ""
  }));
  abcLoaded = true;
}

/* === EMPRESAS / CHIPS === */
function coletarEmpresas(){
  const a = pagamentosAll.map(p=>p.empresa);
  const b = abcAll.map(x=>x.empresa).filter(Boolean);
  empresas = uniq(a.concat(b));
  empresasSelecionadas.clear();
  const merc = empresas.find(e=>String(e).toLowerCase().includes(DEFAULT_EMPRESA));
  if(merc) empresasSelecionadas.add(merc); else empresas.forEach(e=>empresasSelecionadas.add(e));
}
function renderChips(){
  const host=$("#chipsEmpresas"); host.innerHTML="";
  const all=document.createElement("div");
  all.className="chip"+(empresasSelecionadas.size===empresas.length?" active":"");
  all.textContent="Todas";
  all.onclick=()=>{empresasSelecionadas=new Set(empresas); renderChips(); aplicar();}
  host.appendChild(all);
  empresas.forEach(e=>{
    const c=document.createElement("div");
    c.className="chip"+(empresasSelecionadas.has(e)?" active":"");
    c.textContent=e;
    c.onclick=()=>{
      if(empresasSelecionadas.has(e)) empresasSelecionadas.delete(e); else empresasSelecionadas.add(e);
      if(empresasSelecionadas.size===0) empresas.forEach(x=>empresasSelecionadas.add(x));
      renderChips(); aplicar();
    };
    host.appendChild(c);
  });
}

/* === MODAL === */
function openModal(){ $("#modal").style.display="block"; }
function closeModal(){ $("#modal").style.display="none"; $("#mBody").innerHTML=""; }

/* === HISTÓRICO DO FORNECEDOR === */
async function openHistoricoFornecedor(fornecedor){
  $("#mTitle").textContent = fornecedor;
  $("#mSub").textContent = `Histórico de pagamentos em ${ANO}`;
  $("#mBody").innerHTML = `<div class="muted" style="padding:8px 2px">⏳ Carregando histórico…</div>`;
  openModal();
  try{
    const url = `${SHEET_API}?action=histFornecedor&ano=${ANO}&fornecedor=${encodeURIComponent(fornecedor)}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error("HTTP "+r.status);
    const js = await r.json();
    const arr = (js.registros || []).map(p=>({
      data: p.data_pagamento || p.Liquidação || "",
      empresa: p.empresa || p.Empresa || "",
      valor: cleanNumber(p.valor ?? p["Valor Líquido"] ?? 0),
      meio: p.meio_pagamento || p["Meio de Pagamento"] || "",
      hist: p.historico || p["Histórico"] || ""
    })).sort((a,b)=> new Date(b.data) - new Date(a.data));

    const total = arr.reduce((s,x)=>s+x.valor,0);
    // resumo por mês
    const map = {};
    arr.forEach(x=>{
      const k = ymKey(x.data);
      map[k] = (map[k]||0) + x.valor;
    });
    const resumo = Object.entries(map).sort((a,b)=> a[0].localeCompare(b[0]))
      .map(([k,v])=> `<span style="display:inline-block;margin:3px 6px 0 0;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff">${ymLabel(k)} • <b>${brl(v)}</b></span>`).join("");

    const body = `
      <div style="margin-bottom:8px">
        <div><b>Total no ano:</b> ${brl(total)}</div>
        <div style="margin-top:6px">${resumo||'<span class="muted">Sem pagamentos</span>'}</div>
      </div>
      <div class="divider"></div>
      <table class="table" style="width:100%">
        <thead><tr><th>Data</th><th>Empresa</th><th>Meio</th><th>Histórico</th><th>Valor</th></tr></thead>
        <tbody>
          ${arr.map(x=>`
            <tr>
              <td>${String(x.data).slice(0,10)}</td>
              <td>${x.empresa||"-"}</td>
              <td>${x.meio||"-"}</td>
              <td>${x.hist||"-"}</td>
              <td style="text-align:right">${brl(x.valor)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    $("#mBody").innerHTML = body;
  }catch(e){
    $("#mBody").innerHTML = `<div class="muted">Não foi possível carregar o histórico agora.</div>`;
    console.error(e);
  }
}

/* === RENDER === */
function aplicar(){
  const a = $("#fDataIni").value ? new Date($("#fDataIni").value) : null;
  const b = $("#fDataFim").value ? new Date($("#fDataFim").value) : null;

  const pags = pagamentosAll.filter(p=>{
    const okEmp = empresasSelecionadas.has(p.empresa) || (empresasSelecionadas.size===empresas.length);
    const d = parseISO(p.data_pagamento);
    return okEmp && inRange(d,a,b);
  });
  const arrs = abcAll.filter(x=>{
    const d = new Date(x.data);
    const okEmp = x.empresa ? (empresasSelecionadas.has(x.empresa) || (empresasSelecionadas.size===empresas.length)) : true;
    return okEmp && inRange(d,a,b);
  });

  const totalPag = pags.reduce((s,p)=>s+cleanNumber(p.valor),0);
  const totalArr = arrs.reduce((s,x)=>s+cleanNumber(x.faturamento),0);
  const res = totalArr-totalPag;

  $("#kPagamentos").textContent = brl(totalPag);
  $("#kArrecadacao").textContent = abcLoaded ? brl(totalArr) : "⏳ carregando…";
  $("#abcStatus").textContent = abcLoaded ? "" : "Arrecadação sendo carregada em segundo plano";
  $("#kResultado").innerHTML = `${brl(res)} <span class="badge ${res>=0?"lucr":"prej"}">${res>=0?"LUCRO":"PREJUÍZO"}</span>`;

  // tabela/cards – com click para histórico
  const tb=$("#tblPagamentos tbody"); tb.innerHTML="";
  if(pags.length===0){ $("#msgEmpty").style.display="block"; } else { $("#msgEmpty").style.display="none"; }
  // mobile: cards
  if (matchMedia("(max-width: 768px)").matches){
    pags.forEach(p=>{
      const tr=document.createElement("tr");
      tr.className="clickable";
      tr.innerHTML=`
        <td style="display:none"></td><td style="display:none"></td><td style="display:none"></td><td style="display:none"></td>
        <div class="info">
          <div class="pill-supplier">${p.fornecedor||"-"}</div>
          <div class="pill-sub">${p.empresa||"-"} • ${p.data_pagamento||"-"}</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="val-right">${brl(p.valor||0)}</div>
          <div class="chev">›</div>
        </div>`;
      tr.onclick=()=>openHistoricoFornecedor(p.fornecedor);
      tb.appendChild(tr);
    });
  } else {
    // desktop: tabela
    pags.forEach(p=>{
      const tr=document.createElement("tr");
      tr.className="clickable";
      tr.innerHTML=`<td>${p.data_pagamento||"-"}</td>
                    <td>${p.empresa||"-"}</td>
                    <td>${p.fornecedor||"-"}</td>
                    <td>${brl(p.valor||0)}</td>`;
      tr.onclick=()=>openHistoricoFornecedor(p.fornecedor);
      tb.appendChild(tr);
    });
  }

  // resumo por empresa
  const rb=$("#tblResumoEmp tbody"); rb.innerHTML="";
  empresas.forEach(emp=>{
    const pEmp = pagamentosAll.filter(p=>{
      const d=parseISO(p.data_pagamento);
      return p.empresa===emp && inRange(d,a,b);
    });
    const aEmp = abcAll.filter(x=>{
      const d=new Date(x.data);
      return (x.empresa? x.empresa===emp : true) && inRange(d,a,b);
    });
    const tP = pEmp.reduce((s,p)=>s+cleanNumber(p.valor),0);
    const tA = aEmp.reduce((s,x)=>s+cleanNumber(x.faturamento),0);
    const tR = tA - tP;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${emp}</td>
                  <td>${abcLoaded? brl(tA) : "⏳"}</td>
                  <td>${brl(tP)}</td>
                  <td><span class="badge ${tR>=0?"lucr":"prej"}">${abcLoaded? brl(tR) : "⏳"}</span></td>`;
    rb.appendChild(tr);
  });
}

/* === INIT === */
document.getElementById("btnAplicar").onclick=aplicar;

(async function init(){
  const now=new Date();
  const ini=new Date(now.getFullYear(),now.getMonth(),1).toISOString().slice(0,10);
  const fim=new Date(now.getFullYear(),now.getMonth()+1,0).toISOString().slice(0,10);
  $("#fDataIni").value=ini; $("#fDataFim").value=fim;

  try{
    await fetchPagamentos();
    coletarEmpresas(); renderChips();
    aplicar();
    $("#loading").style.display="none";
    $("#empLoadMsg").style.display="block";

    try{
      await fetchABC();
      $("#empLoadMsg").style.display="none";
      aplicar();
    }catch(e){
      console.error(e);
      $("#abcStatus").textContent="Não foi possível carregar o ABC agora.";
    }
  }catch(e){
    console.error(e);
    alert("Erro ao carregar pagamentos: "+e.message);
    $("#loading").style.display="none";
  }
})();
</script>
</body>
</html>
