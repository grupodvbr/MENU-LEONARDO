
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Painel • Couvert Mercatto 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f4f6f8; --card:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --green:#16a34a; --red:#ef4444; --brand:#111827; --accent:#2563eb; --radius:16px;
    --shadow:0 14px 34px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--text)}
  header{background:#111827;color:#fff;padding:14px 20px;display:flex;align-items:center}
  header h1{font-size:16px;margin:0;font-weight:800}
  .wrap{margin:12px auto;padding:0 12px;width:100%;max-width:100%}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .kpi h3{margin:0 0 4px;font-size:13px;color:var(--muted)}
  .kpi .val{font-size:20px;font-weight:800}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
  .table th{font-size:11px;color:var(--muted);text-transform:uppercase}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
  .lucr{background:#eafff0;color:#065f46;border:1px solid #bbf7d0}
  .prej{background:#ffecec;color:#7f1d1d;border:1px solid #fecaca}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{display:flex;gap:6px;flex-wrap:wrap}
  .pill .btn.active{background:#111827;color:#fff;border-color:#111827}
  /* overlay de carregando */
  #loading{
    position:fixed;inset:0;background:rgba(255,255,255,0.8);
    display:flex;align-items:center;justify-content:center;
    font-size:18px;font-weight:700;color:#111827;z-index:100;
  }
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#fff;border-radius:14px;max-width:900px;width:94%;padding:14px}
  .modal h3{margin:0 0 4px}
  .scroll{max-height:70vh;overflow:auto}
  @media(max-width:768px){
    .table, .table thead{display:none}
    .table tr{display:block;margin-bottom:10px;border:1px solid var(--line);border-radius:8px;padding:6px;background:#fff}
    .table td{display:block;border:0;padding:4px 6px;font-size:13px}
    .table td::before{content:attr(data-label) ": ";font-weight:600;color:var(--muted)}
  }
</style>
</head>
<body>
<header><h1>Painel de Arrecadação x Pagamentos</h1></header>

<div id="loading">⏳ Carregando dados...</div>

<div class="wrap">
  <!-- filtros -->
  <div class="card">
    <div class="pill" id="periodPill">
      <button class="btn active" data-period="semana">Semana</button>
      <button class="btn" data-period="mes">Mês</button>
    </div>
    <div style="margin:8px 0">
      <label>Data início: <input type="date" id="fDataIni"></label>
      <label>Data fim: <input type="date" id="fDataFim"></label>
      <button class="btn primary" onclick="filtrarPorData()">Aplicar</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid cols-3">
    <div class="card"><h3>Arrecadação (Couvert)</h3><div class="val" id="kArrecadacao">R$ 0,00</div></div>
    <div class="card"><h3>Pagamentos</h3><div class="val" id="kPagamentos">R$ 0,00</div></div>
    <div class="card"><h3>Resultado</h3><div class="val" id="kResultado">R$ 0,00 <span id="badgeResult" class="badge lucr">LUCRO</span></div></div>
  </div>

  <!-- tabela -->
  <div class="card">
    <h3>Pagamentos</h3>
    <table class="table" id="tblPagamentos">
      <thead><tr><th>Data</th><th>Empresa</th><th>Fornecedor</th><th>Valor</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="msgEmpty" class="muted" style="display:none;margin-top:8px">Nenhum pagamento encontrado nesse período.</div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="box">
    <h3 id="modalTitle">Detalhes</h3>
    <div class="scroll" id="modalBody"></div>
    <button class="btn" onclick="closeModal()">Fechar</button>
  </div>
</div>

<script>
const SHEET_API = "https://script.google.com/macros/s/AKfycbw976EjFnhsDXbXPGZIIqlYvPiQA0OknIQ8_LRg__IJd9QUfCwccV1GzDD_0EqEXRkvdw/exec";   // <-- coloque aqui seu GAS de pagamentos
const ABC_URL   = "https://script.google.com/macros/s/AKfycbxu0HjXsbvXr9OGYDAEfN8Kqyle4d2GFb26wu8aAcAtfM-RkcILV9AywDjf1Fu8rW_NwQ/exec"; // <-- coloque aqui seu script do ABC de vendas
const ANO = 2025;

let pagamentosAll = [];
let dadosABC = [];

function brl(v){return Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function parseISO(d){return new Date(d+"T00:00:00");}
function inRange(d,a,b){return d>=a && d<=b;}
function containsCouvert(item){
  const p=(item.produto||"").toLowerCase();
  if(!p.includes("couvert")) return false;
  const ex=["couvert do villa","couvert delicia","couvert mercatto"];
  return !ex.some(x=>p.includes(x));
}

/*** LOADERS COM ERRO ***/
async function loadPagamentos(){
  try{
    const r=await fetch(`${SHEET_API}?action=listAno&ano=${ANO}`);
    if(!r.ok) throw new Error("Erro HTTP: "+r.status);
    pagamentosAll=await r.json();
  }catch(e){
    alert("Erro ao carregar pagamentos: "+e.message);
    pagamentosAll=[];
  }
}
async function loadABC(){
  try{
    const r=await fetch(ABC_URL);
    if(!r.ok) throw new Error("Erro HTTP: "+r.status);
    const arr=await r.json();
    dadosABC=arr.filter(o=>{
      const d=new Date(o.data);
      return d.getFullYear()===ANO && containsCouvert(o);
    });
  }catch(e){
    alert("Erro ao carregar ABC: "+e.message);
    dadosABC=[];
  }
}

/*** RENDER ***/
function renderTabela(lista){
  const tb=document.querySelector("#tblPagamentos tbody"); tb.innerHTML="";
  if(lista.length===0){
    document.querySelector("#msgEmpty").style.display="block";
    return;
  }
  document.querySelector("#msgEmpty").style.display="none";
  lista.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td data-label="Data">${p.data_pagamento}</td>
      <td data-label="Empresa">${p.empresa||"-"}</td>
      <td data-label="Fornecedor">${p.fornecedor||"-"}</td>
      <td data-label="Valor">${brl(p.valor||0)}</td>`;
    tr.onclick=()=>openModalDetalhe(p);
    tb.appendChild(tr);
  });
}
function openModalDetalhe(p){
  const html=`<p><b>Empresa:</b> ${p.empresa||"-"}</p>
    <p><b>Fornecedor:</b> ${p.fornecedor||"-"}</p>
    <p><b>Histórico:</b> ${p.historico||"-"}</p>
    <p><b>Meio:</b> ${p.meio_pagamento||"-"}</p>
    <p><b>Valor:</b> ${brl(p.valor||0)}</p>`;
  document.querySelector("#modalBody").innerHTML=html;
  document.querySelector("#modal").style.display="flex";
}
function closeModal(){document.querySelector("#modal").style.display="none";}

/*** FILTRO POR DATA ***/
function filtrarPorData(){
  const ini=document.querySelector("#fDataIni").value;
  const fim=document.querySelector("#fDataFim").value;
  if(!ini||!fim) return alert("Selecione as duas datas");
  const a=new Date(ini), b=new Date(fim);

  const pagamentosFiltrados=pagamentosAll.filter(p=>{
    const d=parseISO(p.data_pagamento);
    return inRange(d,a,b);
  });

  const arrecadacaoFiltrada=dadosABC.reduce((s,o)=>{
    const d=new Date(o.data);
    if(inRange(d,a,b)) s+=Number(o.faturamento||0);
    return s;
  },0);

  const totalPag=pagamentosFiltrados.reduce((s,p)=>s+(Number(p.valor)||0),0);
  const resultado=arrecadacaoFiltrada-totalPag;

  document.querySelector("#kArrecadacao").textContent=brl(arrecadacaoFiltrada);
  document.querySelector("#kPagamentos").textContent=brl(totalPag);
  document.querySelector("#kResultado").innerHTML=`${brl(resultado)} <span id="badgeResult" class="badge ${resultado>=0?"lucr":"prej"}">${resultado>=0?"LUCRO":"PREJUÍZO"}</span>`;

  renderTabela(pagamentosFiltrados);
}

/*** INIT ***/
async function init(){
  document.querySelector("#loading").style.display="flex";
  await Promise.all([loadPagamentos(), loadABC()]);
  document.querySelector("#loading").style.display="none";
}
init();
</script>
</body>
</html>
