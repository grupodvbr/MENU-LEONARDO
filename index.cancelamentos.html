<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cancelamentos - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      font-size: 14px;
    }
    header {
      background-color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ccc;
      gap: 10px;
    }
    header img {
      height: 60px;
      flex-shrink: 0;
    }
    header h1 {
      margin: 0;
      font-size: 1.6em;
      font-weight: bold;
      color: #000;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: end;
    }
    .filters select, .filters input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      flex: 1 1 200px;
      font-size: 0.95em;
    }
    .btn-whatsapp {
      background-color: #25D366;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      float: right;
      margin-bottom: 10px;
      font-size: 0.95em;
    }
    .total-cancelado {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    #graficoCancelamentos {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      width: 100% !important;
      max-width: 100%;
      height: 300px !important;
      box-sizing: border-box;
      display: none;
    }
    .dados-analisados {
      text-align: center;
      color: #555;
      font-size: 0.95em;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo CB Systems">
    <h1 id="tituloPainel">Cancelamentos</h1>
  </header>

  <div class="container">
    <div class="filters">
      <input type="date" id="dataInicio" />
      <input type="date" id="dataFim" />
      <select id="filtroEmpresa"></select>
      <input type="text" id="filtroBusca" placeholder="Buscar item..." />
    </div>

    <button class="btn-whatsapp" onclick="enviarWhatsapp()">ðŸ“¤ Enviar via WhatsApp</button>

    <div class="total-cancelado">
      ðŸ“Š Total Cancelado: <span id="totalCancelado"><strong>R$ 0,00</strong></span>
    </div>

    <canvas id="graficoCancelamentos"></canvas>
    <div id="listaCancelamentos"></div>
    <div class="dados-analisados" id="resumoDados"></div>
  </div>

  <!-- Assistente DV -->
  <div id="botaoAssistente" onclick="abrirChat()">DV</div>
  <div id="chatAssistente">
    <header>
      <span>Assistente DV</span>
      <div>
        <button onclick="limparChat()">ðŸ§¹</button>
        <button onclick="fecharChat()">âœ–</button>
      </div>
    </header>
    <div class="mensagens" id="mensagens"></div>
    <div class="entrada">
      <input type="text" id="pergunta" placeholder="FaÃ§a uma pergunta..." onkeypress="if(event.key==='Enter') responderPergunta()">
      <button onclick="responderPergunta()">Enviar</button>
    </div>
  </div>

  <style>
    #botaoAssistente {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle at 30% 30%, #25D366, #128C7E);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      animation: pulsar 2s infinite ease-in-out;
      z-index: 9999;
    }
    #chatAssistente {
      position: fixed;
      bottom: 100px;
      right: 25px;
      width: 300px;
      max-height: 400px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 9998;
      overflow: hidden;
    }
    #chatAssistente header {
      background: #128C7E;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatAssistente .mensagens {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 0.9em;
    }
    #chatAssistente .entrada {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #chatAssistente input {
      flex: 1;
      border: none;
      padding: 10px;
    }
    #chatAssistente button {
      border: none;
      background: #128C7E;
      color: white;
      padding: 10px 15px;
      cursor: pointer;
    }
    @keyframes pulsar {
      0% { box-shadow: 0 0 10px rgba(37, 211, 102, 0.4), 0 0 20px rgba(37, 211, 102, 0.3); }
      50% { box-shadow: 0 0 20px rgba(37, 211, 102, 0.8), 0 0 40px rgba(37, 211, 102, 0.5); }
      100% { box-shadow: 0 0 10px rgba(37, 211, 102, 0.4), 0 0 20px rgba(37, 211, 102, 0.3); }
    }
  </style>

  <script>
    function abrirChat() {
      document.getElementById("chatAssistente").style.display = "flex";
    }
    function fecharChat() {
      document.getElementById("chatAssistente").style.display = "none";
    }
    function limparChat() {
      document.getElementById("mensagens").innerHTML = "";
    }
    function adicionarMensagem(remetente, texto) {
      const div = document.createElement("div");
      div.innerHTML = `<strong>${remetente}:</strong> ${texto}`;
      document.getElementById("mensagens").appendChild(div);
    }
    function responderPergunta() {
      const entrada = document.getElementById("pergunta");
      const pergunta = entrada.value.trim().toLowerCase();
      if (!pergunta) return;
      adicionarMensagem("VocÃª", pergunta);
      entrada.value = "";

      let resposta = "Desculpe, nÃ£o entendi a pergunta.";
      const hoje = new Date().toISOString().split("T")[0];
      const mesAtual = hoje.slice(0, 7);

      const filtradosHoje = cancelamentos.filter(c => c.data === hoje);
      const filtradosMes = cancelamentos.filter(c => c.data.startsWith(mesAtual));
      const totalHoje = filtradosHoje.reduce((acc, c) => acc + c.valor, 0);
      const totalMes = filtradosMes.reduce((acc, c) => acc + c.valor, 0);

      if (pergunta.includes("cancelado hoje")) {
        resposta = `Hoje foram cancelados ${formatarMoeda(totalHoje)}.`;
      } else if (pergunta.includes("total do mÃªs") || pergunta.includes("cancelado no mÃªs")) {
        resposta = `No mÃªs atual foram cancelados ${formatarMoeda(totalMes)}.`;
      } else if (pergunta.includes("padaria")) {
        const padaria = filtradosMes.filter(c => c.empresa.toLowerCase().includes("padaria"));
        const total = padaria.reduce((acc, c) => acc + c.valor, 0);
        resposta = `A Padaria DelÃ­cia cancelou ${formatarMoeda(total)} neste mÃªs.`;
      } else if (pergunta.includes("rodÃ­zio")) {
        const rodizio = filtradosMes.filter(c => c.item.toLowerCase().includes("rodÃ­zio"));
        const total = rodizio.reduce((acc, c) => acc + c.valor, 0);
        resposta = `Cancelamentos de rodÃ­zio neste mÃªs: ${formatarMoeda(total)}.`;
      } else if (pergunta.includes("qual empresa") || pergunta.includes("quem mais cancelou")) {
        const empresas = {};
        filtradosMes.forEach(c => empresas[c.empresa] = (empresas[c.empresa] || 0) + c.valor);
        const top = Object.entries(empresas).sort((a, b) => b[1] - a[1])[0];
        resposta = `A empresa que mais cancelou neste mÃªs foi ${top[0]} com ${formatarMoeda(top[1])}.`;
      }
      adicionarMensagem("DV", resposta);
    }
  </script>
</body>
</html>
