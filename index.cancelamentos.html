<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cancelamentos - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      font-size: 14px;
    }
    header {
      background-color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ccc;
      gap: 10px;
    }
    header img {
      height: 60px;
      flex-shrink: 0;
    }
    header h1 {
      margin: 0;
      font-size: 1.6em;
      font-weight: bold;
      color: #000;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: end;
    }
    .filters select, .filters input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      flex: 1 1 200px;
      font-size: 0.95em;
    }
    .btn-whatsapp {
      background-color: #25D366;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      float: right;
      margin-bottom: 10px;
      font-size: 0.95em;
    }
    .total-cancelado, #graficoCancelamentos, .dados-analisados, #listaCancelamentos {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 15px;
      margin-bottom: 20px;
    }
    #graficoCancelamentos {
      display: none;
    }
    /* Chat assistente */
    #chatAssistente {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      overflow: hidden;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      z-index: 9999;
    }
    #chatMensagens {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    #chatInputWrapper {
      display: flex;
      border-top: 1px solid #eee;
    }
    #chatInputWrapper input {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 13px;
    }
    #chatInputWrapper button {
      background: #25D366;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
    }
    #chatHeader {
      background: #25D366;
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatHeader button {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    #chatSugestoes {
      position: absolute;
      bottom: 65px;
      right: 20px;
      width: 300px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 9998;
      display: none;
    }
    #chatSugestoes ul {
      list-style: none;
      margin: 0;
      padding: 10px;
    }
    #chatSugestoes li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #chatSugestoes li:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

<!-- Painel e filtros (como j√° estavam no c√≥digo anterior) -->
<!-- ... OMITIDO PARA FOCO NO CHAT -->

<!-- Chat Assistente Virtual -->
<div id="chatAssistente">
  <div id="chatHeader">
    ü§ñ Assistente Virtual
    <div>
      <button onclick="limparConversa()">üßπ</button>
      <button onclick="fecharChat()">‚ùå</button>
    </div>
  </div>
  <div id="chatMensagens"></div>
  <div id="chatInputWrapper">
    <input id="chatInput" type="text" placeholder="Pergunte algo..." onkeypress="if(event.key==='Enter')responderPergunta()">
    <button onclick="mostrarSugestoes()">üìé</button>
    <button onclick="responderPergunta()">‚û§</button>
  </div>
</div>
<div id="chatSugestoes">
  <ul>
    <li onclick="usarSugestao(this.innerText)">Quanto foi cancelado m√™s passado?</li>
    <li onclick="usarSugestao(this.innerText)">Qual empresa teve mais cancelamentos?</li>
    <li onclick="usarSugestao(this.innerText)">Resumo de cancelamentos da Padaria Del√≠cia</li>
    <li onclick="usarSugestao(this.innerText)">Quais itens mais cancelados?</li>
    <li onclick="usarSugestao(this.innerText)">Rod√≠zio foi muito cancelado?</li>
  </ul>
</div>

<script>
  let cancelamentos = []; // usar os mesmos dados do painel principal

  function responderPergunta() {
    const input = document.getElementById("chatInput");
    const pergunta = input.value.toLowerCase().normalize("NFD").replace(/[^\w\s]/g, "").trim();
    if (!pergunta) return;
    adicionarMensagem("Voc√™", pergunta);
    input.value = "";

    let resposta = "Desculpe, n√£o entendi sua pergunta.";

    if (pergunta.includes("mes") && pergunta.includes("passado")) {
      const mesAnterior = new Date();
      mesAnterior.setMonth(mesAnterior.getMonth() - 1);
      const mes = mesAnterior.toISOString().slice(0, 7);
      const total = cancelamentos.filter(c => c.data.startsWith(mes)).reduce((a, b) => a + b.valor, 0);
      resposta = `No m√™s passado foram cancelados ${formatarMoeda(total)}.`;
    } else if (pergunta.includes("rodizio")) {
      const total = cancelamentos.filter(c => c.item.toLowerCase().includes("rod√≠zio") || c.item.toLowerCase().includes("rodizio"))
        .reduce((a, b) => a + b.valor, 0);
      resposta = `O total de cancelamentos de rod√≠zio foi ${formatarMoeda(total)}.`;
    } else if (pergunta.includes("empresa") && pergunta.includes("mais")) {
      const totais = {};
      cancelamentos.forEach(c => totais[c.empresa] = (totais[c.empresa] || 0) + c.valor);
      const empresaTop = Object.entries(totais).sort((a, b) => b[1] - a[1])[0];
      resposta = `A empresa com mais cancelamentos foi ${empresaTop[0]} com ${formatarMoeda(empresaTop[1])}.`;
    } else if (pergunta.includes("item") || pergunta.includes("produto")) {
      const itens = {};
      cancelamentos.forEach(c => {
        const nome = c.item.split(" ‚Äì ")[0];
        itens[nome] = (itens[nome] || 0) + c.valor;
      });
      const maisCancelado = Object.entries(itens).sort((a, b) => b[1] - a[1])[0];
      resposta = `O item mais cancelado foi ${maisCancelado[0]} com ${formatarMoeda(maisCancelado[1])}.`;
    } else if (pergunta.includes("cancelamentos") && pergunta.includes("hoje")) {
      const hoje = new Date().toISOString().slice(0,10);
      const total = cancelamentos.filter(c => c.data === hoje).reduce((a, b) => a + b.valor, 0);
      resposta = `Hoje foram cancelados ${formatarMoeda(total)}.`;
    }

    adicionarMensagem("Assistente", resposta);
  }

  function adicionarMensagem(remetente, mensagem) {
    const chat = document.getElementById("chatMensagens");
    const div = document.createElement("div");
    div.innerHTML = `<strong>${remetente}:</strong> ${mensagem}`;
    div.style.marginBottom = "8px";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function limparConversa() {
    document.getElementById("chatMensagens").innerHTML = "";
  }

  function fecharChat() {
    document.getElementById("chatAssistente").style.display = "none";
  }

  function mostrarSugestoes() {
    const box = document.getElementById("chatSugestoes");
    box.style.display = box.style.display === "block" ? "none" : "block";
  }

  function usarSugestao(texto) {
    document.getElementById("chatInput").value = texto;
    document.getElementById("chatSugestoes").style.display = "none";
    responderPergunta();
  }
</script>
</body>
</html>
