<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Vendas Delivery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <style>
    body { font-family: Arial, sans-serif; background: white; margin: 0; padding: 0; }
    header {
      background-color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }
    header img { height: 50px; margin-right: 20px; }
    header h1 { margin: 0; font-size: 1.6em; font-weight: bold; }
    .container { padding: 20px; }
    .chart-box, .total-box, .resumo-box {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    .chart-box canvas { max-width: 100%; height: 180px !important; }
    .filters {
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: end;
    }
    .filters label { font-weight: bold; }
    .filters select, .filters button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
    }
    .filters button {
      background-color: #1e1e2f;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .total-box { text-align: center; font-size: 1.2em; font-weight: bold; }
    .whatsapp-btn {
      background-color: #25d366;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      float: right;
    }
    .resumo-box table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .resumo-box th, .resumo-box td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    .resumo-box th { background: #f5f5f5; }
  </style>
</head>
<body>

<header>
  <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo CB Systems">
  <h1>Vendas Delivery</h1>
</header>

<div class="container">
  <div class="filters">
    <div>
      <label for="mesInicial">MÃªs Inicial</label>
      <select id="mesInicial"></select>
    </div>
    <div>
      <label for="mesFinal">MÃªs Final</label>
      <select id="mesFinal"></select>
    </div>
    <div>
      <label for="empresa">Empresa</label>
      <select id="empresa">
        <option value="Todas">Todas</option>
      </select>
    </div>
    <div>
      <label for="plataforma">Plataforma</label>
      <select id="plataforma">
        <option value="Todas">Todas</option>
        <option value="iFood">iFood</option>
        <option value="Delivery Much">Delivery Much</option>
      </select>
    </div>
    <div>
      <button onclick="carregarDados()">Filtrar GrÃ¡fico</button>
    </div>
  </div>

  <div class="chart-box">
    <h3>ðŸ“ˆ Vendas Brutas por Dia
      <button class="whatsapp-btn" onclick="enviarWhatsapp()">Enviar via WhatsApp</button>
    </h3>
    <canvas id="graficoVendas"></canvas>
  </div>

  <div class="total-box" id="mediaMensal"></div>

  <div class="resumo-box" id="resumo">
    <h3>ðŸ“Š Totais por Plataforma</h3>
    <table>
      <thead><tr><th>Plataforma</th><th>Total</th></tr></thead>
      <tbody id="tabelaResumo"></tbody>
    </table>
  </div>
</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby3tGjtsUXcak51bcWG175VU4SWT2RV6pA9vJLyQxlMXSt3bGJFoi2R0YmDmuwzbcbOnw/exec";
let chart;

const meses = ["Janeiro", "Fevereiro", "MarÃ§o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

window.onload = async () => {
  const hoje = new Date();
  const mesAtual = hoje.getMonth();

  const mesInicial = document.getElementById("mesInicial");
  const mesFinal = document.getElementById("mesFinal");
  meses.forEach((m, i) => {
    mesInicial.innerHTML += `<option value="${i + 1}" ${i === 0 ? 'selected' : ''}>${m}</option>`;
    mesFinal.innerHTML += `<option value="${i + 1}" ${i === mesAtual ? 'selected' : ''}>${m}</option>`;
  });

  await carregarEmpresas();
  carregarDados();
};

async function carregarEmpresas() {
  const res = await fetch(URL_SCRIPT);
  const dados = await res.json();
  const empresas = [...new Set(dados.map(d => d.empresa))].sort();
  const empresaSelect = document.getElementById("empresa");
  empresas.forEach(emp => {
    const opt = document.createElement("option");
    opt.value = emp;
    opt.textContent = emp;
    empresaSelect.appendChild(opt);
  });
}

async function carregarDados() {
  const res = await fetch(URL_SCRIPT);
  const dados = await res.json();

  const mesIni = parseInt(document.getElementById("mesInicial").value);
  const mesFim = parseInt(document.getElementById("mesFinal").value);
  const empresa = document.getElementById("empresa").value;
  const plataforma = document.getElementById("plataforma").value;

  const filtrado = dados.filter(d => {
    const dt = new Date(d.data);
    const mes = dt.getMonth() + 1;
    return mes >= mesIni && mes <= mesFim &&
      (empresa === "Todas" || empresa === d.empresa) &&
      (plataforma === "Todas" || plataforma === d.plataforma);
  });

  const agrupado = {};
  filtrado.forEach(d => {
    const data = new Date(d.data);
    const key = data.toISOString().split("T")[0];
    agrupado[key] = (agrupado[key] || 0) + parseFloat(d.bruto || 0);
  });
  const pontos = Object.entries(agrupado).map(([x, y]) => ({ x, y })).sort((a, b) => new Date(a.x) - new Date(b.x));

  const mesesUnicos = new Set(filtrado.map(d => new Date(d.data).getMonth()));
  const totalGeral = filtrado.reduce((soma, d) => soma + parseFloat(d.bruto || 0), 0);
  const media = totalGeral / mesesUnicos.size;
  document.getElementById("mediaMensal").innerText = `ðŸ“Š MÃ©dia por MÃªs: R$ ${media.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

  const totaisPorPlataforma = {};
  filtrado.forEach(d => {
    const plat = d.plataforma || "Outros";
    totaisPorPlataforma[plat] = (totaisPorPlataforma[plat] || 0) + parseFloat(d.bruto || 0);
  });
  const tbody = document.getElementById("tabelaResumo");
  tbody.innerHTML = Object.entries(totaisPorPlataforma).map(([p, v]) => `<tr><td>${p}</td><td>R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>`).join("");

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("graficoVendas").getContext("2d"), {
    type: "line",
    data: {
      datasets: [{
        label: "Valor Bruto por Dia",
        data: pontos,
        borderColor: "#2980b9",
        backgroundColor: "rgba(41,128,185,0.1)",
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          type: "time",
          time: { unit: "day", tooltipFormat: "dd/MM/yyyy", displayFormats: { day: "dd/MM" } },
          title: { display: true, text: "Data" }
        },
        y: {
          beginAtZero: false,
          ticks: { callback: value => "R$ " + value.toLocaleString("pt-BR") },
          title: { display: true, text: "Valor Bruto" }
        }
      }
    }
  });
}

function enviarWhatsapp() {
  const texto = document.getElementById("mediaMensal").innerText + "\n";
  const linhas = [...document.querySelectorAll("#tabelaResumo tr")].map(l => l.innerText).join("\n");
  const mensagem = encodeURIComponent(texto + linhas);
  window.open(`https://wa.me/?text=${mensagem}`, "_blank");
}
</script>

</body>
</html>
