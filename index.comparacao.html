<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>CB Systems • Comparativo de Planos de Contas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --primary:#0ea5e9;
    --red:#ef4444; --green:#22c55e;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Segoe UI',sans-serif}
  header{background:#0b1220;color:#fff;padding:14px 18px;font-weight:700}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px}
  select,input,button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  .grid{display:grid;gap:16px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.1)}
  h3{margin:0 0 10px}
  ul{margin:0;padding-left:18px}
  li{margin-bottom:6px}
  .btn-link{display:inline-block;margin-top:20px;background:var(--primary);color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;text-decoration:none;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:0.2s}
  .btn-link:hover{filter:brightness(1.1)}
</style>
</head>
<body>
<header>CB Systems • Comparativo de Planos de Contas</header>
<div class="wrap">

  <!-- Filtros -->
  <div class="filters">
    <select id="empresa">
      <option>MERCATTO DELICIA</option>
      <option>DELICIA GOURMET</option>
      <option>VILLA GOURMET</option>
      <option>M. KIDS</option>
      <option>PADARIA DELICIA</option>
    </select>
    <input id="dataInicio" type="month">
    <input id="dataFim" type="month">
    <button id="aplicar">Aplicar</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Comparativo Geral (R$)</h3>
      <canvas id="chartComparativo" height="120"></canvas>
    </div>

    <div class="card">
      <h3>Variação Percentual</h3>
      <canvas id="chartVariacao" height="120"></canvas>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div class="card">
        <h3>Maiores Aumentos</h3>
        <ul id="listaAumentos"></ul>
      </div>
      <div class="card">
        <h3>Maiores Quedas</h3>
        <ul id="listaQuedas"></ul>
      </div>
    </div>
  </div>

  <a href="index.html" class="btn-link">⬅ Voltar ao Painel</a>

</div>

<script>
const API_BASE='https://script.google.com/macros/s/AKfycbyDGQ-srD7OFMORoRo7ZH2BDaz_tJVVlsqjdlLTI0OpkEKv3tQ5Ny02h3blo7GKjsFEIw/exec';
const moeda=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const parseBR=v=>{ if(v==null) return 0; const s=String(v).replace(/[^\d\-.,]/g,'').replace(/\.(?=\d{3})/g,'').replace(',','.'); return parseFloat(s)||0; };
function extractPlanos(rec){ return (rec?.planosFonte9||[]).map(p=>({nome:p.nome,valor:parseBR(p.valor)})); }
function planosToMap(planos){ const map={}; planos.forEach(p=>{ map[p.nome]=(map[p.nome]||0)+p.valor; }); return map; }
async function getEmpresaPeriodo(emp, periodo){ const url=`${API_BASE}?empresa=${encodeURIComponent(emp)}&periodo=${encodeURIComponent(periodo)}`; const r=await fetch(url); return r.json(); }
function buildRows(mapCurr, mapPrev){
  const nomes = new Set([...Object.keys(mapCurr), ...Object.keys(mapPrev)]);
  const rows=[];
  nomes.forEach(nome=>{
    const atual=mapCurr[nome]||0, antes=mapPrev[nome]||0;
    rows.push({nome, antes, atual, inc:atual-antes, pct:antes?((atual-antes)/antes*100):0});
  });
  return rows;
}

let chart1, chart2;
async function run(){
  const emp=document.getElementById('empresa').value;
  const perFim=document.getElementById('dataFim').value;
  const perInicio=document.getElementById('dataInicio').value || perFim;

  const curr=await getEmpresaPeriodo(emp, perFim);
  const old=await getEmpresaPeriodo(emp, perInicio);

  const planosCurr=extractPlanos(curr);
  const planosPrev=extractPlanos(old);
  const mapCurr=planosToMap(planosCurr);
  const mapPrev=planosToMap(planosPrev);

  const rows=buildRows(mapCurr,mapPrev)
    .sort((a,b)=>Math.abs(b.inc)-Math.abs(a.inc));

  const labels=rows.map(r=>r.nome);
  const valsCurr=rows.map(r=>r.atual);
  const valsPrev=rows.map(r=>r.antes);
  const pct=rows.map(r=>r.pct);

  // Chart 1 - Comparativo R$
  if(chart1) chart1.destroy();
  chart1=new Chart(document.getElementById('chartComparativo'),{
    type:'bar',
    data:{labels:labels,datasets:[
      {label:perInicio,data:valsPrev,backgroundColor:'#94a3b8',barThickness:20},
      {label:perFim,data:valsCurr,backgroundColor:'#0ea5e9',barThickness:20}
    ]},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v=>moeda(v)}}}}
  });

  // Chart 2 - Variação %
  if(chart2) chart2.destroy();
  chart2=new Chart(document.getElementById('chartVariacao'),{
    type:'bar',
    data:{labels:labels,datasets:[
      {label:'Variação %',data:pct,backgroundColor:pct.map(v=>v>=0?'#22c55e':'#ef4444')}
    ]},
    options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{callback:v=>v+'%'}}}}
  });

  // Listas
  const topAum=rows.filter(r=>r.inc>0).slice(0,10);
  const topQued=rows.filter(r=>r.inc<0).slice(0,10);
  document.getElementById('listaAumentos').innerHTML=topAum.map(r=>`<li>${r.nome} — ${moeda(r.inc)}</li>`).join('');
  document.getElementById('listaQuedas').innerHTML=topQued.map(r=>`<li>${r.nome} — ${moeda(r.inc)}</li>`).join('');
}

document.getElementById('aplicar').addEventListener('click',run);
window.addEventListener('DOMContentLoaded',()=>{
  const hoje=new Date();
  const mesAtual=hoje.toISOString().slice(0,7);
  const mesAnterior=new Date(hoje.getFullYear(), hoje.getMonth()-1, 1).toISOString().slice(0,7);
  document.getElementById('dataFim').value=mesAtual;
  document.getElementById('dataInicio').value=mesAnterior;
  run();
});
</script>
</body>
</html>
